<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Store Admin ‚Äî Menu Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/styles/ag-theme-alpine.css">
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@32.3.3/dist/ag-grid-community.min.noStyle.js"></script>
  <style>
    :root {
      --bg: #F0F4FA;
      --surface: #ffffff;
      --surface2: #f8fafc;
      --border: #e2e8f0;
      --border2: #cbd5e1;
      --text: #0f172a;
      --text2: #64748b;
      --text3: #94a3b8;
      --primary: #006241;
      --primary-light: rgba(0,98,65,0.10);
      --success: #059669;
      --success-light: #ecfdf5;
      --danger: #dc2626;
      --danger-light: #fef2f2;
      --warning: #d97706;
      --warning-light: #fffbeb;
      --radius: 12px;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* ============================================
       RETAIL ADMIN OUTER CHROME
       ============================================ */

    /* MAIN COLUMN */
    .ra-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    /* CONTENT AREA (page scrolls, not this div) */
    .ra-content {
      background: var(--bg);
    }

    /* ============================================
       INNER CONTENT STYLES (preserved)
       ============================================ */

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      border: none;
      transition: all 0.15s;
      white-space: nowrap;
      text-decoration: none;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #004d33; }
    .btn-ghost {
      background: var(--surface2);
      color: var(--text2);
      border: 1px solid var(--border);
    }
    .btn-ghost:hover { background: var(--border); color: var(--text); }
    .btn-sm { padding: 6px 11px; font-size: 12px; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: #b91c1c; }

    /* FILTERS */
    .filters-bar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px 18px;
      margin-bottom: 18px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .search-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 14px;
      flex: 1;
      min-width: 180px;
    }
    .search-wrap input {
      background: none; border: none; outline: none;
      color: var(--text); font-size: 14px;
      font-family: 'Inter', sans-serif; width: 100%;
    }
    .search-wrap input::placeholder { color: var(--text3); }
    .filter-pills { display: flex; gap: 6px; flex-wrap: wrap; }
    .pill {
      padding: 5px 13px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
      white-space: nowrap;
      user-select: none;
    }
    .pill-all { background: var(--surface2); border-color: var(--border); color: var(--text2); }
    .pill-all.active, .pill-all:hover { background: var(--primary); border-color: var(--primary); color: #fff; }

    .pill-breakfast { background: #fffbeb; border-color: #fde68a; color: #92400e; }
    .pill-breakfast.active, .pill-breakfast:hover { background: #f59e0b; border-color: #f59e0b; color: #fff; }
    .pill-lunch { background: #f0fdf4; border-color: #bbf7d0; color: #14532d; }
    .pill-lunch.active, .pill-lunch:hover { background: #16a34a; border-color: #16a34a; color: #fff; }
    .pill-dinner { background: #f5f3ff; border-color: #ddd6fe; color: #4c1d95; }
    .pill-dinner.active, .pill-dinner:hover { background: #7c3aed; border-color: #7c3aed; color: #fff; }
    .pill-drinks { background: #eff6ff; border-color: #bfdbfe; color: #1e3a8a; }
    .pill-drinks.active, .pill-drinks:hover { background: #2563eb; border-color: #2563eb; color: #fff; }
    .pill-specials { background: #fff1f2; border-color: #fecdd3; color: #881337; }
    .pill-specials.active, .pill-specials:hover { background: #e11d48; border-color: #e11d48; color: #fff; }

    /* STOCK FILTER */
    .stock-filter { display: flex; gap: 6px; }
    .stock-pill {
      padding: 5px 11px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
      user-select: none;
    }
    .stock-pill-all { background: var(--surface2); border-color: var(--border2); color: var(--text2); }
    .stock-pill-all.active { background: var(--text); border-color: var(--text); color: #fff; }
    .stock-pill-in { background: var(--success-light); border-color: #a7f3d0; color: var(--success); }
    .stock-pill-in.active { background: var(--success); border-color: var(--success); color: #fff; }
    .stock-pill-out { background: var(--danger-light); border-color: #fecaca; color: var(--danger); }
    .stock-pill-out.active { background: var(--danger); border-color: var(--danger); color: #fff; }

    /* SUMMARY BAR */
    .summary-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .summary-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
    }
    .summary-chip .num { font-family: 'Oswald', sans-serif; font-size: 22px; font-weight: 700; color: var(--primary); line-height: 1; }
    .summary-chip .lbl { font-size: 11px; font-weight: 600; color: var(--text2); }

    /* ITEM GRID */
    .items-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(268px, 1fr));
      gap: 16px;
    }

    /* ITEM CARD */
    .item-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: box-shadow 0.15s, border-color 0.15s;
    }
    .item-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .item-card.oos { border-color: #fca5a5; }
    .item-card.inactive-item { opacity: 0.6; }
    .item-card-img {
      width: 100%;
      height: 154px;
      background: #f1f5f9;
      position: relative;
      overflow: hidden;
    }
    .item-card-img img { width: 100%; height: 100%; object-fit: cover; }
    .item-card-img .no-img {
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      font-size: 40px; color: #cbd5e1;
    }
    .oos-overlay {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.55);
      align-items: center;
      justify-content: center;
    }
    .item-card.oos .oos-overlay { display: flex; }
    .oos-badge-card {
      background: var(--danger);
      color: #fff;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      padding: 6px 14px;
      border-radius: 4px;
      transform: rotate(-8deg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .inactive-overlay {
      display: none;
      position: absolute;
      top: 10px; left: 10px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 4px;
    }
    .item-card.inactive-item .inactive-overlay { display: block; }
    .item-card-body { padding: 14px 16px; }
    .item-card-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .item-sku-tag { font-size: 10px; font-weight: 700; font-family: monospace; color: var(--text3); letter-spacing: 0.5px; }
    .item-cat-tag { font-size: 10px; font-weight: 600; background: var(--surface2); color: var(--text2); padding: 2px 7px; border-radius: 20px; }
    .item-card-name { font-size: 15px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
    .item-card-desc {
      font-size: 12px; color: var(--text2); line-height: 1.5; margin-bottom: 8px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .nutrition-strip { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
    .nutr-chip { display: inline-flex; align-items: baseline; gap: 2px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 20px; padding: 2px 8px; font-size: 11px; }
    .nutr-chip .nv { font-weight: 800; color: #059669; }
    .nutr-chip .nl { font-weight: 500; color: #6b7280; }
    .item-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }
    .item-price { font-family: 'Oswald', sans-serif; font-size: 20px; font-weight: 700; color: var(--primary); letter-spacing: 0.3px; }
    .item-types { display: flex; gap: 4px; flex-wrap: wrap; flex: 1; }
    .type-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

    /* OOS TOGGLE */
    .oos-toggle-wrap { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .oos-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--success-light);
      border: 2px solid #a7f3d0;
      border-radius: 8px;
      padding: 7px 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      font-weight: 700;
      color: var(--success);
      user-select: none;
    }
    .oos-toggle:hover { filter: brightness(0.95); }
    .oos-toggle.out-of-stock { background: var(--danger-light); border-color: #fca5a5; color: var(--danger); }
    .oos-toggle .toggle-icon { font-size: 14px; }
    .oos-update-time { font-size: 9px; color: var(--text3); text-align: center; }

    /* EMPTY STATE */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 64px 32px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; }
    .empty-state h3 { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
    .empty-state p { font-size: 14px; color: var(--text2); max-width: 360px; margin: 0 auto; line-height: 1.6; }

    /* NO STORE PAGE */
    .no-store-page {
      display: none;
      height: 100%;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }
    .no-store-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      max-width: 480px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }
    .no-store-box .icon { font-size: 48px; margin-bottom: 16px; }
    .no-store-box h2 { font-size: 20px; font-weight: 700; margin-bottom: 10px; }
    .no-store-box p { font-size: 14px; color: var(--text2); margin-bottom: 24px; line-height: 1.6; }
    .url-example {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 12px;
      color: var(--text2);
      text-align: left;
      margin: 10px 0;
      font-family: monospace;
      word-break: break-all;
    }

    /* TOPBAR */
    .ra-topbar {
      background: #fff;
      border-bottom: 3px solid var(--primary);
      height: 54px;
      display: flex;
      align-items: center;
      padding: 0 20px;
      gap: 12px;
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .ra-topbar-title {
      font-family: 'Oswald', sans-serif;
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .ra-store-badge {
      background: var(--primary-light);
      color: var(--primary);
      border: 1px solid rgba(0,98,65,0.25);
      font-size: 11px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 20px;
      letter-spacing: 0.5px;
    }
    .ra-topbar-spacer { flex: 1; }
    .ra-topbar-back {
      font-size: 12px;
      color: var(--text2);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--surface2);
    }
    .ra-topbar-back:hover { background: var(--border); color: var(--text); }

    /* MAIN PAGE */
    .page { padding: 20px 24px; }

    /* TOAST */
    .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 999; display: flex; flex-direction: column; gap: 10px; }
    .toast {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #1e293b;
      color: #fff;
      border-radius: 10px;
      padding: 12px 18px;
      font-size: 13px;
      font-weight: 500;
      min-width: 260px;
      max-width: 360px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      animation: toastIn 0.2s ease;
    }
    .toast.success { border-left: 3px solid #10b981; }
    .toast.error { border-left: 3px solid #ef4444; }
    .toast.info { border-left: 3px solid #3b82f6; }

    /* CONFIRM DIALOG */
    .confirm-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .confirm-overlay.open { display: flex; }
    .confirm-box {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 16px;
      padding: 32px;
      max-width: 380px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    }
    .confirm-box .icon { font-size: 40px; margin-bottom: 14px; }
    .confirm-box h3 { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
    .confirm-box p { font-size: 14px; color: var(--text2); margin-bottom: 24px; line-height: 1.5; }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }

    /* AUTO REFRESH */
    @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.3} }
    @keyframes toastIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateX(20px); } }

    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

    @media (max-width: 700px) {
      .filters-bar { flex-direction: column; align-items: stretch; }
    }

    /* ‚îÄ‚îÄ AG-GRID THEME OVERRIDES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .ag-theme-alpine {
      --ag-background-color:          var(--surface);
      --ag-header-background-color:   var(--surface2);
      --ag-odd-row-background-color:  var(--surface);
      --ag-row-hover-color:           var(--surface2);
      --ag-border-color:              var(--border);
      --ag-header-foreground-color:   var(--text2);
      --ag-foreground-color:          var(--text);
      --ag-font-family:               'Inter', sans-serif;
      --ag-font-size:                 13px;
      --ag-cell-horizontal-padding:   12px;
      --ag-floating-filter-height:    36px;
    }
    .ag-theme-alpine .ag-header-cell-label { font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px; }
    .ag-theme-alpine .ag-floating-filter-input { font-family:'Inter',sans-serif;font-size:12px; }
    .ag-theme-alpine .ag-cell { display:flex;align-items:center; }
    .ag-theme-alpine .ag-cell-wrapper { width:100%; }
    /* Always show the filter icon button (default: only on hover) */
    .ag-theme-alpine .ag-header-cell-filter-button { opacity: 1 !important; }
    /* Highlight filter icon when a filter is active */
    .ag-theme-alpine .ag-header-cell-filtered .ag-icon-filter { color: var(--primary) !important; }
    .ag-theme-alpine .ag-header-cell-filtered { background: var(--primary-light) !important; }

    /* ‚îÄ‚îÄ STICKY AG-GRID HEADER (domLayout: autoHeight) ‚îÄ‚îÄ‚îÄ */
    /* Must unset overflow on ancestor wrappers or sticky won't fire */
    .ag-theme-alpine .ag-root-wrapper,
    .ag-theme-alpine .ag-root {
      overflow: visible !important;
    }
    .ag-theme-alpine .ag-header {
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    }

    /* ‚îÄ‚îÄ CHECKBOX SET FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .csf-wrap {
      width: 230px;
      background: var(--surface);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
    }
    .csf-search-row {
      padding: 8px;
      border-bottom: 1px solid var(--border);
    }
    .csf-search {
      width: 100%;
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      font-family: inherit;
      outline: none;
      background: var(--surface2);
      color: var(--text);
    }
    .csf-list {
      max-height: 230px;
      overflow-y: auto;
      padding: 4px 0;
    }
    .csf-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text);
      line-height: 1.4;
    }
    .csf-item:hover { background: var(--surface2); }
    .csf-item input[type=checkbox] { cursor: pointer; accent-color: var(--primary); flex-shrink: 0; }
    .csf-footer {
      display: flex;
      gap: 6px;
      padding: 7px 8px;
      border-top: 1px solid var(--border);
      background: var(--surface2);
    }
    .csf-btn-all, .csf-btn-none {
      flex: 1;
      padding: 4px 6px;
      font-size: 11px;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 5px;
      cursor: pointer;
      background: var(--surface);
      color: var(--text2);
      font-weight: 600;
    }
    .csf-btn-all:hover { background: var(--primary); color: #fff; border-color: var(--primary); }
    .csf-btn-none:hover { background: var(--danger); color: #fff; border-color: var(--danger); }
  </style>
</head>
<body>

<!-- =============================================
     RETAIL ADMIN MAIN COLUMN
     ============================================= -->
<div class="ra-main">

  <!-- SCROLLABLE CONTENT -->
  <div class="ra-content">

    <!-- NO STORE PAGE -->
    <div class="no-store-page" id="noStorePage" style="display:none;">
      <div class="no-store-box">
        <div class="icon">üîê</div>
        <h2>Store Code Required</h2>
        <p>Access your store's menu management interface by including your Unique Store Code in the URL.</p>
        <div class="url-example">store-admin.html?store=<strong>STORE001</strong></div>
        <div class="url-example">store-admin.html?store=<strong>STORE001</strong>&amp;staff=<strong>STAFF001</strong></div>
        <p style="font-size:13px;margin-top:8px;color:var(--text2);">Or use the redirect portal:</p>
        <div class="url-example">index.html?store=<strong>STORE001</strong></div>
        <a href="index.html" class="btn btn-primary" style="margin-top:16px;">‚Üê Go to Portal</a>
      </div>
    </div>

    <!-- MAIN PAGE -->
    <div class="page" id="mainPage" style="display:none;">

      <!-- SUMMARY -->
      <div class="summary-bar" id="summaryBar"></div>

      <!-- ITEMS GRID (AG-Grid) -->
      <div id="itemsGrid" class="ag-theme-alpine" style="width:100%;border-radius:var(--radius);border:1px solid var(--border);"></div>

    </div><!-- /page -->

  </div><!-- /ra-content -->
</div><!-- /ra-main -->

<!-- CONFIRM DIALOG -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="icon" id="confirmIcon">‚ùì</div>
    <h3 id="confirmTitle">Confirm Action</h3>
    <p id="confirmMsg">Are you sure?</p>
    <div class="confirm-actions">
      <button class="btn btn-ghost" onclick="closeConfirm()">Cancel</button>
      <button class="btn" id="confirmBtn">Confirm</button>
    </div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toastContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// ===== FIREBASE INIT =====
const firebaseConfig = {
  apiKey: "AIzaSyDrUKPNep2uxbZjYJ4i0vImdG7Xn_UuSXo",
  authDomain: "rob-ph-demos.firebaseapp.com",
  projectId: "rob-ph-demos",
  storageBucket: "rob-ph-demos.firebasestorage.app",
  messagingSenderId: "199417645406",
  appId: "1:199417645406:web:0e7a54d00083b41ea9e7cf"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const MB         = 'menuboard';
const ITEMS_COLL = 'items';
const STOCK_COLL = 'stock';

const MENU_TYPES = [
  { id: 'breakfast', label: 'Breakfast', emoji: 'üåÖ', color: '#f59e0b' },
  { id: 'lunch', label: 'Lunch', emoji: '‚òÄÔ∏è', color: '#16a34a' },
  { id: 'dinner', label: 'Dinner', emoji: 'üåô', color: '#7c3aed' },
  { id: 'drinks', label: 'Drinks', emoji: 'ü•§', color: '#2563eb' },
  { id: 'specials', label: "Today's Specials", emoji: '‚≠ê', color: '#e11d48' }
];

// Parse URL params
const urlParams = new URLSearchParams(window.location.search);
const STORE_CODE = (urlParams.get('store') || '').trim().toUpperCase();
const STAFF_ID = (urlParams.get('staff') || '').trim().toUpperCase();

// ===== IN-MEMORY CACHE =====
let _items    = [];
let _stock    = {};
let _settings = { currency: '$' };

// ===== FIRESTORE LISTENERS =====
onSnapshot(collection(db, ITEMS_COLL), snap => {
  _items = snap.docs.map(d => d.data()).sort((a, b) => (a.createdAt || '').localeCompare(b.createdAt || ''));
  if (STORE_CODE && document.getElementById('mainPage').style.display !== 'none') renderItems();
});

onSnapshot(doc(db, MB, 'settings'), snap => {
  _settings = snap.exists() ? snap.data() : { currency: '$' };
});

if (STORE_CODE) {
  onSnapshot(doc(db, STOCK_COLL, STORE_CODE), snap => {
    _stock = snap.exists() ? snap.data() : {};
    if (document.getElementById('mainPage').style.display !== 'none') renderItems();
  });
}

let storeItemsGridApi = null;

// ‚îÄ‚îÄ CHECKBOX SET FILTER (Community AG-Grid) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class CheckboxSetFilter {
  init(params) {
    this.params = params;
    this.allValues = [];
    this.checkedValues = new Set();
    this.eGui = document.createElement('div');
    this.eGui.className = 'csf-wrap';
    this.eGui.innerHTML =
      '<div class="csf-search-row"><input class="csf-search" type="text" placeholder="Search‚Ä¶"></div>' +
      '<div class="csf-list"></div>' +
      '<div class="csf-footer"><button class="csf-btn-all">Select All</button><button class="csf-btn-none">Clear All</button></div>';
    this._searchEl = this.eGui.querySelector('.csf-search');
    this._listEl   = this.eGui.querySelector('.csf-list');
    this._searchEl.addEventListener('input', () => this._renderList());
    this.eGui.querySelector('.csf-btn-all').addEventListener('click', () => {
      this.allValues.forEach(v => this.checkedValues.add(v));
      this._renderList(); params.filterChangedCallback();
    });
    this.eGui.querySelector('.csf-btn-none').addEventListener('click', () => {
      this.checkedValues.clear();
      this._renderList(); params.filterChangedCallback();
    });
    this._refresh();
  }
  _rawValue(data) {
    const customVg = this.params.colDef.getFilterValue ||
                     (this.params.filterParams && this.params.filterParams.valueGetter);
    if (customVg) return customVg(data);
    const vg = this.params.colDef.valueGetter;
    if (typeof vg === 'function') return vg({ data, node: { data } });
    return data[this.params.colDef.field];
  }
  _refresh() {
    const seen = new Set();
    this.params.api.forEachNode(node => {
      const raw = this._rawValue(node.data);
      if (Array.isArray(raw)) raw.forEach(v => v != null && seen.add(String(v)));
      else if (raw != null && String(raw).trim()) seen.add(String(raw).trim());
    });
    this.allValues = [...seen].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
    // Inclusion mode: empty checkedValues = no filter (show all). Don't auto-populate.
    this._renderList();
  }
  _renderList() {
    const q = this._searchEl.value.toLowerCase();
    const itemRenderer = this.params.filterParams?.itemRenderer || this.params.colDef?.filterParams?.itemRenderer;
    this._listEl.innerHTML = '';
    this.allValues.filter(v => v.toLowerCase().includes(q)).forEach(v => {
      const lbl = document.createElement('label');
      lbl.className = 'csf-item';
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.checked = this.checkedValues.has(v);
      cb.addEventListener('change', () => {
        cb.checked ? this.checkedValues.add(v) : this.checkedValues.delete(v);
        this.params.filterChangedCallback();
      });
      lbl.appendChild(cb);
      const content = itemRenderer ? itemRenderer(v) : document.createTextNode('\u00a0' + v);
      lbl.appendChild(content);
      this._listEl.appendChild(lbl);
    });
  }
  getGui()          { return this.eGui; }
  isFilterActive()  { return this.checkedValues.size > 0 && this.checkedValues.size < this.allValues.length; }
  doesFilterPass(p) {
    const raw = this._rawValue(p.data);
    if (Array.isArray(raw)) return raw.some(v => this.checkedValues.has(String(v)));
    return this.checkedValues.has(String(raw ?? '').trim());
  }
  getModel()   { return this.isFilterActive() ? { values: [...this.checkedValues] } : null; }
  setModel(m)  {
    this.checkedValues.clear();
    if (m && m.values) m.values.forEach(v => this.checkedValues.add(v));
    // Inclusion mode: null model = clear filter (empty = show all), no auto-populate
    this._renderList();
  }
  onNewRowsLoaded() { this._refresh(); }
  destroy() {}
}

// INIT
function init() {
  if (!STORE_CODE) {
    document.getElementById('noStorePage').style.display = 'flex';
    document.title = 'Store Admin ‚Äî Access Required';
    return;
  }

  document.getElementById('mainPage').style.display = 'block';
  document.title = 'Store ' + STORE_CODE + ' ‚Äî Menu Admin';
  const badge = document.getElementById('storeCodeBadge');
  if (badge && STORE_CODE) { badge.textContent = 'üè™ ' + STORE_CODE; badge.style.display = ''; }

  initGrid();
  renderItems();
  requestAnimationFrame(() => storeItemsGridApi && storeItemsGridApi.sizeColumnsToFit());
}

// DATA
function getItems()    { return _items; }
function getSettings() { return _settings; }
function getStock()    { return _stock; }
function saveStock(s) {
  _stock = s;
  setDoc(doc(db, STOCK_COLL, STORE_CODE), s)
    .catch(err => toast('\u274C Sync failed: ' + (err.message || err), 'error'));
}

function isOos(sku) {
  const stock = getStock();
  return !!(stock[sku] && stock[sku].outOfStock);
}

// GRID INIT
function initGrid() {
  const el = document.getElementById('itemsGrid');
  if (!el || storeItemsGridApi) return;
  storeItemsGridApi = agGrid.createGrid(el, {
    domLayout: 'autoHeight',
    rowHeight: 90,
    suppressCellFocus: true,
    defaultColDef: {
      resizable: true,
      sortable: true,
      filter: 'agTextColumnFilter',
    },
    columnDefs: [
      {
        headerName: 'Image', field: 'images', width: 100, maxWidth: 100,
        filter: false, sortable: false, resizable: false,
        cellRenderer: (params) => {
          const item = params.data;
          const wrap = document.createElement('div');
          wrap.style.cssText = 'height:100%;display:flex;align-items:center;justify-content:center;';
          if (item.images && item.images[0]) {
            const img = document.createElement('img');
            img.src = item.images[0]; img.alt = item.name;
            img.style.cssText = 'width:70px;height:70px;object-fit:cover;border-radius:8px;';
            wrap.appendChild(img);
          } else {
            const em = document.createElement('span');
            em.style.cssText = 'font-size:32px;';
            em.textContent = '\u{1F37D}\uFE0F';
            wrap.appendChild(em);
          }
          return wrap;
        }
      },
      {
        headerName: 'Product Name', field: 'name', flex: 2.5, minWidth: 160,
        cellRenderer: (params) => {
          const item = params.data;
          const div = document.createElement('div');
          div.style.cssText = 'display:flex;flex-direction:column;justify-content:center;align-items:center;height:100%;gap:2px;text-align:center;';
          const nameEl = document.createElement('div');
          nameEl.style.cssText = 'font-weight:600;color:var(--text);font-size:13px;';
          nameEl.textContent = item.name;
          div.appendChild(nameEl);
          if (item.description) {
            const descEl = document.createElement('div');
            descEl.style.cssText = 'font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px;';
            descEl.textContent = item.description;
            div.appendChild(descEl);
          }
          const skuEl = document.createElement('div');
          skuEl.style.cssText = 'font-size:10px;color:var(--text2);font-family:monospace;margin-top:1px;';
          skuEl.textContent = item.sku;
          div.appendChild(skuEl);
          return div;
        }
      },
      {
        headerName: 'Category', field: 'category', flex: 1.2, minWidth: 120,
        filter: CheckboxSetFilter
      },
      {
        headerName: 'Menu Types', field: 'menuTypes', flex: 1.5, minWidth: 150,
        sortable: false, autoHeight: true,
        filter: CheckboxSetFilter,
        filterParams: {
          itemRenderer: (value) => {
            const mt = MENU_TYPES.find(m => (m.emoji + ' ' + m.label) === value);
            const span = document.createElement('span');
            if (mt) {
              span.style.cssText = `display:inline-flex;align-items:center;gap:4px;padding:2px 8px 2px 5px;border-radius:20px;border:1.5px solid ${mt.color};font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;white-space:nowrap;color:${mt.color};background:transparent;`;
              span.textContent = mt.emoji + ' ' + mt.label;
            } else { span.textContent = value; }
            return span;
          }
        },
        getFilterValue: (data) => (data.menuTypes || []).map(t => {
          const mt = MENU_TYPES.find(m => m.id === t);
          return mt ? mt.emoji + ' ' + mt.label : t;
        }),
        cellRenderer: (params) => {
          const wrap = document.createElement('div');
          wrap.style.cssText = 'display:flex;gap:4px;flex-wrap:wrap;align-items:center;padding:4px 0;';
          (params.value || []).forEach(t => {
            const mt = MENU_TYPES.find(m => m.id === t);
            if (!mt) return;
            const span = document.createElement('span');
            span.style.cssText = `display:inline-flex;align-items:center;gap:4px;padding:3px 9px 3px 6px;border-radius:20px;border:1.5px solid ${mt.color};font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;white-space:nowrap;color:${mt.color};background:transparent;`;
            span.textContent = mt.emoji + ' ' + mt.label;
            wrap.appendChild(span);
          });
          return wrap;
        }
      },
      {
        headerName: 'Ingredients', flex: 1.5, minWidth: 130,
        valueGetter: (p) => (p.data.ingredients || []).join(', ') || '\u2014',
        cellStyle: { fontSize: '12px', color: 'var(--text2)' }
      },
      {
        headerName: 'Price', field: 'price', flex: 0.9, minWidth: 90,
        filter: 'agNumberColumnFilter',
        valueFormatter: (p) => (getSettings().currency || '$') + parseFloat(p.value || 0).toFixed(2),
        cellStyle: { fontWeight: '700', color: 'var(--primary)' }
      },
      {
        headerName: 'In Stock', flex: 1.2, minWidth: 140,
        sortable: true,
        filter: CheckboxSetFilter,
        valueGetter: (p) => isOos(p.data.sku) ? 'Out of Stock' : 'In Stock',
        cellRenderer: (params) => {
          const item = params.data;
          const oos = isOos(item.sku);
          const btn = document.createElement('div');
          btn.style.cssText = `display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;border:1px solid ${oos ? 'var(--danger)' : 'var(--success)'};color:${oos ? 'var(--danger)' : 'var(--success)'};background:${oos ? 'rgba(220,38,38,0.06)' : 'rgba(5,150,105,0.06)'};`;
          btn.textContent = oos ? '\u26D4 Out of Stock' : '\u2705 In Stock';
          btn.addEventListener('click', () => toggleOos(item.sku, item.name, oos));
          return btn;
        }
      }
    ]
  });
}

// RENDER
function renderItems() {
  const allItems = getItems();

  // Summary counts (always based on all items)
  const totalActive = allItems.filter(i => i.active).length;
  const totalOos = allItems.filter(i => i.active && isOos(i.sku)).length;
  const totalIn = totalActive - totalOos;

  document.getElementById('summaryBar').innerHTML = `
    <div class="summary-chip">
      <div><div class="num">${totalActive}</div><div class="lbl">Active Items</div></div>
    </div>
    <div class="summary-chip">
      <div><div class="num" style="color:var(--success)">${totalIn}</div><div class="lbl">In Stock</div></div>
    </div>
    <div class="summary-chip">
      <div><div class="num" style="color:var(--danger)">${totalOos}</div><div class="lbl">Out of Stock</div></div>
    </div>
  `;

  if (!storeItemsGridApi) return;

  // Sort: active first, then alphabetically ‚Äî AG-Grid handles column-level filtering
  const sorted = [...allItems].sort((a, b) => {
    if (a.active !== b.active) return a.active ? -1 : 1;
    return a.name.localeCompare(b.name);
  });

  storeItemsGridApi.setGridOption('rowData', sorted);
}

// OOS TOGGLE
let pendingOos = null;

function toggleOos(sku, name, currentlyOos) {
  pendingOos = { sku, currentlyOos };
  const action = currentlyOos ? 'Mark as In Stock' : 'Mark as Out of Stock';
  const icon = currentlyOos ? '‚úÖ' : '‚õî';
  const msg = currentlyOos
    ? `"${name}" will be marked as available. The menu board will update immediately.`
    : `"${name}" will be flagged as Out of Stock for ${STORE_CODE}. An Out of Stock badge will appear on the menu board.`;

  document.getElementById('confirmIcon').textContent = icon;
  document.getElementById('confirmTitle').textContent = action;
  document.getElementById('confirmMsg').textContent = msg;

  const btn = document.getElementById('confirmBtn');
  btn.textContent = action;
  btn.className = 'btn ' + (currentlyOos ? 'btn-primary' : 'btn-danger');
  btn.onclick = doToggleOos;

  document.getElementById('confirmOverlay').classList.add('open');
}

function doToggleOos() {
  if (!pendingOos) return;
  const { sku, currentlyOos } = pendingOos;
  const stock = { ...getStock() };
  const now = new Date().toISOString();

  if (!stock[sku]) stock[sku] = {};
  stock[sku] = {
    outOfStock: !currentlyOos,
    updatedBy: STAFF_ID || null,
    updatedAt: now
  };

  saveStock(stock);
  closeConfirm();
  renderItems();

  const msg = currentlyOos ? '‚úÖ Item marked as In Stock' : '‚õî Item marked as Out of Stock';
  toast(msg, currentlyOos ? 'success' : 'error');
}

function closeConfirm() {
  document.getElementById('confirmOverlay').classList.remove('open');
  pendingOos = null;
}

// UTILS
function formatTime(iso) {
  const d = new Date(iso);
  const now = new Date();
  const diff = Math.floor((now - d) / 60000);
  if (diff < 1) return 'just now';
  if (diff < 60) return `${diff}m ago`;
  if (diff < 1440) return `${Math.floor(diff/60)}h ago`;
  return d.toLocaleDateString();
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function toast(msg, type = 'info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(() => { el.style.animation = 'toastOut 0.2s ease forwards'; setTimeout(() => el.remove(), 200); }, 3000);
}

// ===== WINDOW EXPORTS (for inline event handlers) =====
window.renderItems = renderItems;
window.toggleOos = toggleOos;
window.doToggleOos = doToggleOos;
window.closeConfirm = closeConfirm;

// INIT
init();
</script>
</body>
</html>
