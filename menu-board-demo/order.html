<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Order â€” Menu</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'Inter', sans-serif;
  background: var(--body, #f9f4ec);
  color: var(--text, #1a1a1a);
  min-height: 100dvh;
  overscroll-behavior: none;
}
img { display: block; max-width: 100%; }
button { cursor: pointer; border: none; background: none; font-family: inherit; }

/* â”€â”€ DESIGN TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --green:        #006241;
  --green-dark:   #004d33;
  --green-light:  #e8f5ef;
  --gold:         #CBA258;
  --gold-dark:    #a8823d;
  --cream:        #f9f4ec;
  --cream-dark:   #f0e8d8;
  --white:        #ffffff;
  --text:         #1a1a1a;
  --text-muted:   #6b7280;
  --border:       #e5e0d8;
  --red:          #dc2626;
  --shadow-sm:    0 1px 3px rgba(0,0,0,.08);
  --shadow-md:    0 4px 16px rgba(0,0,0,.12);
  --shadow-lg:    0 8px 32px rgba(0,0,0,.18);
  --radius-sm:    8px;
  --radius-md:    12px;
  --radius-lg:    20px;
  --header-h:     0px;
  --cat-h:        60px;
  --search-h:     54px;
  --host-header-height: 0px;
}

/* â”€â”€ LAYOUT SCAFFOLDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-header {
  display: none; /* Header removed â€” hidden but kept for JS compatibility */
}
.header-title { }
.header-greeting { }

/* â”€â”€ CATEGORY BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.cat-bar {
  position: fixed; top: var(--header-h); left: 0; right: 0; z-index: 100;
  height: var(--cat-h);
  background: var(--green-dark);
  display: flex; align-items: center;
  overflow-x: auto; overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  gap: 6px; padding: 0 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
}
.cat-bar::-webkit-scrollbar { display: none; }
.cat-tab {
  flex-shrink: 0;
  padding: 9px 18px; border-radius: 24px;
  font-size: 13px; font-weight: 600;
  color: rgba(255,255,255,.75);
  transition: all .15s; white-space: nowrap;
  letter-spacing: .3px;
  border: 1.5px solid transparent;
}
.cat-tab:active { opacity: .75; }
.cat-tab.active {
  background: var(--gold);
  color: var(--green-dark);
  font-weight: 700;
  border-color: var(--gold);
  box-shadow: 0 2px 8px rgba(203,162,88,.4);
}

/* â”€â”€ SEARCH BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.search-bar {
  position: fixed; top: var(--cat-h); left: 0; right: 0; z-index: 99;
  height: var(--search-h);
  background: var(--white);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center;
  padding: 0 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,.06);
}
.search-input-wrap {
  flex: 1; display: flex; align-items: center;
  background: var(--cream); border-radius: 24px;
  border: 1.5px solid var(--border);
  padding: 0 14px; gap: 8px;
  height: 40px;
  transition: border-color .15s, box-shadow .15s;
}
.search-input-wrap:focus-within {
  border-color: var(--green);
  box-shadow: 0 0 0 3px rgba(0,98,65,.1);
}
.search-icon {
  color: var(--text-muted); flex-shrink: 0;
  display: flex; align-items: center;
}
.search-input {
  flex: 1; border: none; background: none;
  font-family: 'Inter', sans-serif;
  font-size: 14px; color: var(--text);
  outline: none;
}
.search-input::placeholder { color: var(--text-muted); }
/* Remove browser default clear button on search inputs */
.search-input::-webkit-search-cancel-button { display: none; }
.search-clear {
  flex-shrink: 0; width: 20px; height: 20px;
  border-radius: 50%; background: var(--text-muted);
  color: var(--white); font-size: 14px; line-height: 1;
  display: none; align-items: center; justify-content: center;
  cursor: pointer; font-weight: 700;
}
.search-clear.visible { display: flex; }

/* â”€â”€ GREETING BANNER (personalisation) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.greeting-banner {
  position: fixed; top: calc(var(--cat-h) + var(--search-h)); left: 0; right: 0; z-index: 97;
  background: var(--green);
  color: var(--white);
  font-size: 13px; font-weight: 500;
  padding: 8px 16px;
  text-align: center;
  letter-spacing: .3px;
  box-shadow: 0 2px 8px rgba(0,0,0,.12);
}

/* â”€â”€ FLOATING BAG BUTTON (FAB) â€” HIGH CONTRAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bag-fab {
  position: fixed;
  bottom: max(80px, calc(28px + env(safe-area-inset-bottom, 0px)));
  right: 20px;
  z-index: 200;
  width: 68px;
  height: 68px;
  border-radius: 50%;
  /* Gold background + dark green icon = maximum contrast against any background */
  background: var(--gold);
  color: var(--green-dark);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 20px rgba(0,0,0,.45), 0 2px 8px rgba(0,0,0,.25);
  cursor: pointer;
  border: 3px solid var(--white);
  transition: transform .15s, box-shadow .15s;
}
.bag-fab:hover {
  box-shadow: 0 8px 28px rgba(0,0,0,.55), 0 4px 12px rgba(0,0,0,.3);
  transform: scale(1.07);
}
.bag-fab:active {
  transform: scale(0.92);
}
.bag-badge {
  position: absolute; top: -5px; right: -5px;
  min-width: 24px; height: 24px; padding: 0 5px;
  border-radius: 12px;
  background: var(--green-dark); color: var(--white);
  font-size: 12px; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  display: none;
  border: 2.5px solid var(--white);
  box-shadow: 0 2px 6px rgba(0,0,0,.3);
}
.bag-badge.visible { display: flex; }

/* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main-content {
  padding-top: calc(var(--cat-h) + var(--search-h) + 16px);
  padding-bottom: calc(100px + env(safe-area-inset-bottom, 0px));
  padding-left: 12px; padding-right: 12px;
  max-width: 1200px; margin: 0 auto;
}
/* Shift content down when personalisation greeting banner is visible */
.main-content.has-greeting {
  padding-top: calc(var(--cat-h) + var(--search-h) + 37px + 16px);
}

/* Search results label */
.search-results-label {
  font-size: 13px; color: var(--text-muted);
  margin-bottom: 12px; font-weight: 500;
}
.search-results-label strong { color: var(--text); }

/* â”€â”€ ITEMS GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.items-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
@media (min-width: 640px) {
  .items-grid { grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .main-content { padding-left: 20px; padding-right: 20px; }
}
@media (min-width: 1024px) {
  .items-grid { grid-template-columns: repeat(4, 1fr); gap: 20px; }
  .main-content { padding-left: 32px; padding-right: 32px; }
  .app-header { padding: 0 32px; }
  .cat-bar { padding: 0 32px; }
  .search-bar { padding: 0 32px; }
}

.item-card {
  background: var(--white);
  border-radius: var(--radius-md);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
  transition: transform .15s, box-shadow .15s;
  position: relative;
  display: flex; flex-direction: column;
}
.item-card:active { transform: scale(.97); }
.item-card.oos { opacity: .55; pointer-events: none; }
.item-card .thumb {
  width: 100%; aspect-ratio: 4/3;
  object-fit: cover; background: var(--green);
  display: flex; align-items: center; justify-content: center;
}
.item-card .thumb img { width: 100%; height: 100%; object-fit: cover; }
.item-card .thumb-placeholder {
  width: 100%; aspect-ratio: 4/3;
  background: var(--green); overflow: hidden;
}
.item-card .thumb-placeholder img { width: 100%; height: 100%; object-fit: cover; }
.item-card .card-body {
  padding: 10px 12px 12px; flex: 1;
  display: flex; flex-direction: column; gap: 4px;
}
.item-card .card-name {
  font-size: 14px; font-weight: 600; line-height: 1.3;
  color: var(--text);
}
.item-card .card-cat {
  font-size: 11px; color: var(--text-muted); text-transform: uppercase;
  letter-spacing: .5px;
}
.item-card .card-footer {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 8px;
}
.item-card .card-price {
  font-family: 'Oswald', sans-serif;
  font-size: 18px; font-weight: 600; color: var(--green-dark);
}
.item-card .add-icon {
  padding: 0 12px;
  height: 32px;
  border-radius: 16px;
  background: var(--green); color: var(--white);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; line-height: 1;
  letter-spacing: 0.3px;
  white-space: nowrap;
  flex-shrink: 0;
  cursor: pointer;
  border: none;
}
.oos-badge {
  position: absolute; top: 8px; left: 8px;
  background: var(--red); color: var(--white);
  font-size: 10px; font-weight: 700; letter-spacing: .5px;
  padding: 3px 7px; border-radius: 4px; text-transform: uppercase;
}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0; z-index: 200;
  background: rgba(0,0,0,.5);
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity .22s;
}
.modal-overlay.open {
  opacity: 1; pointer-events: all;
}
.modal-sheet {
  background: var(--white);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  width: 100%; max-width: 540px;
  max-height: 92dvh;
  display: flex; flex-direction: column;
  overflow: hidden;
  transform: translateY(100%);
  transition: transform .28s cubic-bezier(.32,0,.67,0);
}
.modal-scroll {
  flex: 1; min-height: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}
.modal-overlay.open .modal-sheet {
  transform: translateY(0);
  transition: transform .28s cubic-bezier(.33,1,.68,1);
}
@media (min-width: 640px) {
  .modal-overlay { align-items: center; }
  .modal-sheet {
    border-radius: var(--radius-lg);
    max-height: 88dvh;
    margin: 16px;
  }
}

.modal-img {
  width: 100%; aspect-ratio: 16/9; background: var(--green);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  overflow: hidden; flex-shrink: 0;
}
.modal-img img { width: 100%; height: 100%; object-fit: cover; }
.modal-body { padding: 20px 20px 24px; }
.modal-close {
  position: absolute; top: 12px; right: 12px;
  width: 36px; height: 36px; border-radius: 50%;
  background: rgba(0,0,0,.35); color: var(--white);
  font-size: 20px; display: flex; align-items: center; justify-content: center;
  z-index: 10;
}
.modal-sheet { position: relative; }
.modal-name {
  font-family: 'Oswald', sans-serif; font-size: 24px; font-weight: 600;
  color: var(--text); line-height: 1.2;
}
.modal-desc {
  font-size: 13px; color: var(--text-muted); line-height: 1.55;
  margin-top: 6px;
}
.modal-base-price {
  font-family: 'Oswald', sans-serif; font-size: 20px;
  color: var(--green-dark); margin-top: 4px;
}

.modal-section { margin-top: 20px; }
.modal-section-title {
  font-size: 12px; font-weight: 700; letter-spacing: .8px;
  text-transform: uppercase; color: var(--text-muted);
  margin-bottom: 10px;
  padding-bottom: 6px; border-bottom: 1px solid var(--border);
}

/* Size pills */
.size-grid { display: flex; gap: 8px; flex-wrap: wrap; }
.size-pill {
  flex: 1; min-width: 80px;
  padding: 10px 8px; border-radius: var(--radius-sm);
  border: 2px solid var(--border);
  text-align: center; cursor: pointer; transition: all .12s;
}
.size-pill input { display: none; }
.size-pill:has(input:checked),
.size-pill.selected {
  border-color: var(--green); background: var(--green-light);
}
.size-pill .size-label { font-size: 13px; font-weight: 600; }
.size-pill .size-price {
  font-size: 11px; color: var(--text-muted); margin-top: 2px;
}
.size-pill:has(input:checked) .size-price,
.size-pill.selected .size-price { color: var(--green); }

/* Milk options */
.option-list { display: flex; flex-direction: column; gap: 6px; }
.option-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 12px; border-radius: var(--radius-sm);
  border: 2px solid var(--border); cursor: pointer; transition: all .12s;
}
.option-row:has(input:checked),
.option-row.selected {
  border-color: var(--green); background: var(--green-light);
}
.option-row input { display: none; }
.option-row .opt-label { font-size: 14px; font-weight: 500; }
.option-row .opt-price { font-size: 12px; color: var(--text-muted); }
.option-row:has(input:checked) .opt-price,
.option-row.selected .opt-price { color: var(--green); }

/* Default ingredients tags */
.ingredient-tags { display: flex; flex-wrap: wrap; gap: 8px; }
.ingredient-tag {
  display: flex; align-items: center; gap: 6px;
  padding: 6px 10px; border-radius: 20px;
  background: var(--cream-dark); font-size: 13px; font-weight: 500;
  border: 1px solid var(--border); transition: all .12s;
}
.ingredient-tag.removed {
  background: #fee2e2; border-color: #fca5a5;
  color: var(--text-muted); text-decoration: line-through;
}
.ingredient-tag .ing-remove {
  font-size: 16px; color: var(--text-muted); line-height: 1;
  cursor: pointer; font-weight: 600;
  width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; background: rgba(0,0,0,.08);
}
.ingredient-tag.removed .ing-remove { color: var(--red); background: rgba(220,38,38,.15); }

/* Additions checkboxes */
.addon-list { display: flex; flex-direction: column; gap: 6px; }
.addon-row {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 12px; border-radius: var(--radius-sm);
  border: 2px solid var(--border); cursor: pointer; transition: all .12s;
}
.addon-row:has(input:checked),
.addon-row.checked { border-color: var(--green); background: var(--green-light); }
.addon-row input { display: none; }
.addon-check {
  width: 20px; height: 20px; border-radius: 4px; flex-shrink: 0;
  border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;
  font-size: 13px; transition: all .12s;
}
.addon-row:has(input:checked) .addon-check,
.addon-row.checked .addon-check { background: var(--green); border-color: var(--green); color: var(--white); }
.addon-row .addon-label { flex: 1; font-size: 14px; }
.addon-row .addon-price { font-size: 12px; color: var(--green); font-weight: 600; }
.addon-row .addon-price.free { color: var(--text-muted); }

/* Quantity + Add button row */
.modal-footer {
  flex-shrink: 0;
  background: var(--white);
  padding: 16px 20px calc(16px + env(safe-area-inset-bottom, 0px));
  border-top: 1px solid var(--border);
  display: flex; align-items: center; gap: 12px;
}
.qty-control {
  display: flex; align-items: center; gap: 0;
  border: 2px solid var(--border); border-radius: var(--radius-sm);
  overflow: hidden; flex-shrink: 0;
}
.qty-btn {
  width: 38px; height: 38px;
  background: var(--cream); font-size: 20px; font-weight: 500;
  color: var(--text); display: flex; align-items: center; justify-content: center;
  transition: background .1s;
}
.qty-btn:active { background: var(--cream-dark); }
.qty-val {
  width: 36px; text-align: center;
  font-size: 16px; font-weight: 600; color: var(--text);
}
.add-to-bag-btn {
  flex: 1; padding: 0 20px; height: 56px;
  background: var(--green); color: var(--white);
  border-radius: var(--radius-md);
  font-family: 'Oswald', sans-serif; font-size: 19px; font-weight: 700;
  letter-spacing: 1px;
  display: flex; align-items: center; justify-content: space-between;
  transition: background .12s;
  box-shadow: 0 4px 12px rgba(0,98,65,.35);
}
.add-to-bag-btn:active { background: var(--green-dark); }
.add-to-bag-btn .btn-price { font-size: 17px; }

/* â”€â”€ BAG PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bag-overlay {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,.4);
  opacity: 0; pointer-events: none;
  transition: opacity .22s;
}
.bag-overlay.open { opacity: 1; pointer-events: all; }
.bag-panel {
  position: fixed; top: var(--host-header-height, 0px); right: 0; bottom: 0; z-index: 301;
  height: calc(100svh - var(--host-header-height, 0px));
  width: min(400px, 100vw);
  background: var(--white);
  transform: translateX(100%);
  transition: transform .28s cubic-bezier(.32,0,.67,0);
  display: flex; flex-direction: column;
  box-shadow: var(--shadow-lg);
}
.bag-overlay.open .bag-panel {
  transform: translateX(0);
  transition: transform .28s cubic-bezier(.33,1,.68,1);
}
.bag-header {
  padding: 20px 20px 16px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.bag-title {
  font-family: 'Oswald', sans-serif; font-size: 22px; font-weight: 700;
  color: var(--text);
}
.bag-close {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--cream-dark);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: var(--text);
}
.bag-items {
  flex: 1; overflow-y: auto; padding: 12px 20px;
  display: flex; flex-direction: column; gap: 12px;
}
.bag-empty {
  flex: 1; display: flex; flex-direction: column; align-items: center;
  justify-content: center; gap: 12px; color: var(--text-muted);
  padding: 40px 20px;
}
.bag-empty .empty-icon { font-size: 48px; }
.bag-empty p { font-size: 15px; text-align: center; }
.bag-item-row {
  background: var(--cream); border-radius: var(--radius-sm);
  padding: 12px; display: flex; flex-direction: column; gap: 6px;
}
.bag-item-top { display: flex; align-items: flex-start; gap: 8px; }
.bag-item-name { flex: 1; font-size: 14px; font-weight: 600; line-height: 1.3; }
.bag-item-line-total {
  font-family: 'Oswald', sans-serif; font-size: 16px;
  color: var(--green-dark); flex-shrink: 0;
}
.bag-item-mods {
  font-size: 12px; color: var(--text-muted); line-height: 1.5;
}
.bag-item-actions {
  display: flex; align-items: center; gap: 8px; margin-top: 4px;
}
.bag-qty-control {
  display: flex; align-items: center; gap: 0;
  border: 1.5px solid var(--border); border-radius: 6px; overflow: hidden;
}
.bag-qty-btn {
  width: 28px; height: 28px;
  background: var(--white); font-size: 16px;
  color: var(--text); display: flex; align-items: center; justify-content: center;
}
.bag-qty-val {
  width: 28px; text-align: center; font-size: 13px; font-weight: 600;
}
.bag-remove-btn {
  margin-left: auto;
  font-size: 12px; color: var(--text-muted);
  text-decoration: underline;
}
.bag-footer {
  padding: 16px 20px calc(32px + env(safe-area-inset-bottom, 20px));
  border-top: 1px solid var(--border); flex-shrink: 0;
  background: var(--white);
}
.bag-subtotal {
  display: flex; justify-content: space-between; align-items: center;
  font-size: 16px; font-weight: 600; margin-bottom: 12px;
}
.bag-subtotal .subtotal-val {
  font-family: 'Oswald', sans-serif; font-size: 26px; color: var(--green-dark);
}
.bag-item-count {
  font-size: 12px; color: var(--text-muted); font-weight: 400;
  margin-left: 6px;
}
.place-order-btn {
  width: 100%; padding: 0 24px; height: 52px;
  background: var(--green); color: var(--white);
  border-radius: var(--radius-sm);
  font-family: 'Oswald', sans-serif; font-size: 18px; font-weight: 600;
  letter-spacing: .5px;
  transition: background .12s;
}
.place-order-btn:active { background: var(--green-dark); }
.place-order-btn:disabled {
  background: var(--border); color: var(--text-muted); cursor: not-allowed;
}
.bag-actions { display: flex; flex-direction: column; gap: 10px; }
.clear-bag-btn {
  width: 100%; height: 44px;
  background: transparent;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: 'Oswald', sans-serif; font-size: 16px; font-weight: 600;
  color: var(--text-muted); letter-spacing: .5px;
  cursor: pointer; transition: all .12s;
}
.clear-bag-btn:active { background: var(--cream-dark); }
.clear-bag-btn.confirming { border-color: var(--red); color: var(--red); }

/* â”€â”€ ORDER CONFIRMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.confirm-screen {
  position: fixed; inset: 0; z-index: 400;
  background: #006241; /* intentionally hardcoded â€” not overridable by brand */
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 32px 24px;
  opacity: 0; pointer-events: none;
  transition: opacity .3s;
}
.confirm-screen.open { opacity: 1; pointer-events: all; }
.confirm-check {
  font-size: 72px; margin-bottom: 20px;
  animation: pop .4s cubic-bezier(.36,.07,.19,.97) both;
}
@keyframes pop {
  0%   { transform: scale(0); }
  70%  { transform: scale(1.15); }
  100% { transform: scale(1); }
}
.confirm-order-label {
  font-family: 'Oswald', sans-serif;
  font-size: 20px; font-weight: 400;
  color: rgba(255,255,255,.8); letter-spacing: 2px;
  text-transform: uppercase; margin-bottom: 8px;
}
.confirm-order-number {
  font-family: 'Oswald', sans-serif;
  font-size: 72px; font-weight: 700;
  color: var(--gold); letter-spacing: 4px;
  line-height: 1; margin-bottom: 24px;
}
.confirm-tagline {
  font-size: 15px; color: rgba(255,255,255,.75);
  text-align: center; margin-bottom: 32px; line-height: 1.5;
}
.confirm-items {
  background: rgba(255,255,255,.1); border-radius: var(--radius-md);
  padding: 16px 20px; width: 100%; max-width: 380px;
  margin-bottom: 32px;
  max-height: 35dvh; overflow-y: auto;
}
.confirm-item {
  display: flex; justify-content: space-between;
  font-size: 14px; color: rgba(255,255,255,.9);
  padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,.1);
}
.confirm-item:last-child { border-bottom: none; }
.confirm-item .ci-qty { color: var(--gold); font-weight: 700; margin-right: 6px; }
.confirm-total {
  font-family: 'Oswald', sans-serif; font-size: 18px;
  color: var(--white); margin-top: 10px;
  display: flex; justify-content: space-between;
}
.new-order-btn {
  padding: 0 40px; height: 52px;
  background: var(--white); color: var(--green);
  border-radius: var(--radius-sm);
  font-family: 'Oswald', sans-serif; font-size: 18px; font-weight: 700;
  letter-spacing: .5px;
  transition: opacity .12s;
}
.new-order-btn:active { opacity: .85; }
.confirm-status-bar {
  width: 100%; max-width: 380px;
  margin-bottom: 20px;
  border-radius: var(--radius-md);
  padding: 14px 20px;
  background: rgba(255,255,255,.15);
  font-size: 16px; font-weight: 600;
  color: var(--white);
  text-align: center;
  letter-spacing: 0.2px;
  transition: opacity .4s ease;
  opacity: 0;
}
.confirm-status-bar.visible { opacity: 1; }

/* â”€â”€ LOADING / EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.state-screen {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 60dvh; gap: 16px; color: var(--text-muted);
}
.state-screen .state-icon { font-size: 48px; }
.state-screen h2 { font-family: 'Oswald', sans-serif; font-size: 22px; color: var(--text); }
.state-screen p { font-size: 14px; text-align: center; }

/* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bag-items::-webkit-scrollbar { width: 4px; }
.bag-items::-webkit-scrollbar-track { background: transparent; }
.bag-items::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* â”€â”€ LOYALTY SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* Name-for-order bar â€” shown at top of bag panel */
.bag-name-row {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--cream);
  flex-shrink: 0;
}
.bag-name-row-label {
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.4px; color: var(--text-muted); margin-bottom: 8px;
}
.bag-name-input-row {
  display: flex; gap: 8px; align-items: center;
}
.bag-name-input {
  flex: 1; padding: 9px 12px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit; font-size: 15px;
  color: var(--text); background: var(--white);
  outline: none; transition: border-color .15s;
}
.bag-name-input:focus { border-color: var(--green); }
.bag-name-save-btn {
  padding: 9px 16px;
  background: var(--green); color: var(--white);
  border-radius: var(--radius-sm);
  font-family: inherit; font-size: 14px; font-weight: 600;
  transition: opacity .12s;
  flex-shrink: 0;
}
.bag-name-save-btn:disabled { opacity: .4; cursor: default; }
.bag-name-save-btn:not(:disabled):active { opacity: .8; }
.bag-name-greeting {
  display: flex; align-items: center; justify-content: space-between; gap: 8px;
}
.bag-name-greeting-text {
  font-size: 15px; font-weight: 600; color: var(--text);
}
.bag-name-forget-btn {
  font-size: 12px; color: var(--text-muted);
  text-decoration: underline; padding: 0; background: none; border: none;
  cursor: pointer; flex-shrink: 0;
}
.bag-name-forget-btn:hover { color: var(--danger); }

/* Star loyalty icon in bag header */
.bag-loyalty-btn {
  width: 36px; height: 36px; border-radius: 50%;
  background: var(--gold);
  color: var(--green-dark);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  box-shadow: 0 2px 6px rgba(203,162,88,.4);
  transition: transform .12s, box-shadow .12s;
  flex-shrink: 0;
}
.bag-loyalty-btn:active { transform: scale(0.9); }
.bag-loyalty-btn.hidden { display: none; }

/* Loyalty overlay + bottom-sheet */
.loyalty-overlay {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,.5);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity .2s;
}
.loyalty-overlay.open { opacity: 1; pointer-events: all; }
.loyalty-sheet {
  width: min(420px, calc(100vw - 32px));
  background: var(--white);
  border-radius: var(--radius-lg);
  padding: 24px;
  transform: scale(0.92);
  transition: transform .25s cubic-bezier(.33,1,.68,1);
  display: flex; flex-direction: column; gap: 14px;
  max-height: 90svh; overflow-y: auto;
}
.loyalty-overlay.open .loyalty-sheet { transform: scale(1); }
.loyalty-sheet-handle { display: none; }
.loyalty-sheet-title {
  font-family: 'Oswald', sans-serif;
  font-size: 22px; font-weight: 700;
  color: var(--text); text-align: center;
}
.loyalty-greeting-text {
  font-size: 14px; color: var(--text-muted);
  text-align: center; line-height: 1.5;
}
.loyalty-name-input {
  width: 100%; padding: 12px 16px;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: inherit; font-size: 16px;
  color: var(--text); background: var(--cream);
  outline: none; transition: border-color .15s;
}
.loyalty-name-input:focus { border-color: var(--green); }
.loyalty-save-btn {
  width: 100%; height: 48px;
  background: var(--green); color: var(--white);
  border-radius: var(--radius-sm);
  font-family: 'Oswald', sans-serif; font-size: 17px; font-weight: 600;
  letter-spacing: .5px; transition: background .12s;
}
.loyalty-save-btn:active { background: var(--green-dark); }
.loyalty-save-btn:disabled { background: var(--border); color: var(--text-muted); cursor: not-allowed; }
.loyalty-hi-text {
  font-family: 'Oswald', sans-serif;
  font-size: 28px; font-weight: 700;
  color: var(--green); text-align: center;
}
.loyalty-fav-summary {
  background: var(--cream); border-radius: var(--radius-sm);
  padding: 12px 14px;
  font-size: 13px; color: var(--text-muted); line-height: 1.6;
}
.loyalty-fav-summary strong {
  display: block; color: var(--text);
  font-size: 11px; text-transform: uppercase; letter-spacing: .5px;
  margin-bottom: 4px;
}
.loyalty-update-name {
  font-size: 13px; color: var(--text-muted);
  text-align: center; text-decoration: underline;
  background: none; border: none; cursor: pointer;
  padding: 4px;
}
.loyalty-forget-btn {
  width: 100%; height: 44px;
  background: transparent;
  border: 1.5px solid var(--red);
  border-radius: var(--radius-sm);
  font-family: 'Oswald', sans-serif; font-size: 15px; font-weight: 600;
  color: var(--red); letter-spacing: .5px;
  transition: background .12s;
}
.loyalty-forget-btn:active { background: rgba(220,38,38,.08); }

/* Favourite order checkbox row in bag footer */
.bag-fav-row {
  display: flex; align-items: center; gap: 10px;
  margin-bottom: 10px;
  padding: 10px 12px;
  background: var(--cream); border-radius: var(--radius-sm);
  border: 1.5px solid var(--gold);
  cursor: pointer;
}
.bag-fav-row input[type="checkbox"] {
  width: 18px; height: 18px;
  accent-color: var(--green); flex-shrink: 0;
}
.bag-fav-row label {
  font-size: 13px; font-weight: 500; color: var(--text);
  cursor: pointer; line-height: 1.3;
}

/* FAB popup â€” positioned above the FAB */
.fab-popup {
  position: fixed;
  bottom: calc(max(80px, 28px + env(safe-area-inset-bottom, 0px)) + 80px);
  right: 14px;
  z-index: 201;
  max-width: 260px;
  background: var(--green);
  color: var(--white);
  border-radius: var(--radius-md);
  padding: 12px 36px 12px 14px;
  box-shadow: 0 6px 24px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.2);
  font-size: 13px; line-height: 1.4; font-weight: 500;
  display: none;
  cursor: pointer;
  animation: fabPopIn .2s cubic-bezier(.33,1,.68,1) both;
}
.fab-popup.visible { display: block; }
@keyframes fabPopIn {
  from { opacity: 0; transform: translateY(8px) scale(0.96); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.fab-popup::after {
  content: '';
  position: absolute; bottom: -8px; right: 26px;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-top: 8px solid var(--green);
}
.fab-popup-close {
  position: absolute; top: 6px; right: 8px;
  font-size: 16px; line-height: 1;
  color: rgba(255,255,255,.8);
  background: none; border: none; cursor: pointer; padding: 4px;
}
.fab-popup-close:hover { color: var(--white); }
.fab-popup-add-btn {
  display: block;
  width: 100%;
  margin-top: 8px;
  padding: 7px 10px;
  border: none;
  border-radius: 4px;
  background: var(--white);
  color: var(--green);
  font-family: 'Oswald', sans-serif;
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.5px;
  cursor: pointer;
  text-align: center;
  transition: background .1s;
}
.fab-popup-add-btn:active { background: rgba(255,255,255,0.85); }
</style>
</head>
<body>

<!-- Hidden header â€” kept for JS compatibility (applyBranding targets these IDs) -->
<header class="app-header" id="appHeader" aria-hidden="true">
  <div class="logo-placeholder" id="headerLogo">â˜•</div>
  <div style="flex:1;min-width:0;">
    <div class="header-title" id="headerTitle">Loadingâ€¦</div>
    <div class="header-greeting" id="headerGreeting"></div>
  </div>
</header>

<!-- â”€â”€ CATEGORY BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav class="cat-bar" id="catBar"></nav>

<!-- â”€â”€ SEARCH BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="search-bar" id="searchBar">
  <div class="search-input-wrap">
    <span class="search-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
      </svg>
    </span>
    <input class="search-input" id="searchInput" type="search" placeholder="Search the menuâ€¦" autocomplete="off" autocorrect="off" spellcheck="false">
    <button class="search-clear" id="searchClear" aria-label="Clear search">Ã—</button>
  </div>
</div>

<!-- â”€â”€ PERSONALISATION GREETING BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="greeting-banner" id="greetingBanner" style="display:none;"></div>

<!-- â”€â”€ FLOATING BAG BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<button class="bag-fab" id="bagBtn" aria-label="Open takeout bag">
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z"/>
    <line x1="3" y1="6" x2="21" y2="6"/>
    <path d="M16 10a4 4 0 01-8 0"/>
  </svg>
  <span class="bag-badge" id="bagBadge">0</span>
</button>

<!-- â”€â”€ FAB LOYALTY POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="fab-popup" id="fabPopup">
  <button class="fab-popup-close" id="fabPopupClose" aria-label="Dismiss">Ã—</button>
  <div id="fabPopupText"></div>
  <button class="fab-popup-add-btn" id="fabPopupAddBtn">+ ADD FAVOURITES</button>
</div>

<!-- â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<main class="main-content">
  <div id="menuView">
    <div class="state-screen" id="loadingState">
      <div class="state-icon">â³</div>
      <h2>Loading Menuâ€¦</h2>
    </div>
    <div id="searchResultsLabel" class="search-results-label" style="display:none;"></div>
    <div class="items-grid" id="itemsGrid" style="display:none;"></div>
  </div>
</main>

<!-- â”€â”€ ITEM CUSTOMISATION MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true">
  <div class="modal-sheet" id="modalSheet">
    <div class="modal-scroll">
      <button class="modal-close" id="modalClose" aria-label="Close">Ã—</button>
      <div class="modal-img" id="modalImg"></div>
      <div class="modal-body">
        <div class="modal-name" id="modalName"></div>
        <div class="modal-desc" id="modalDesc"></div>
        <div class="modal-base-price" id="modalBasePrice"></div>
        <div id="modalSizes"></div>
        <div id="modalMilk"></div>
        <div id="modalIngredients"></div>
        <div id="modalAddons"></div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="qty-control">
        <button class="qty-btn" id="qtyMinus">âˆ’</button>
        <span class="qty-val" id="qtyVal">1</span>
        <button class="qty-btn" id="qtyPlus">+</button>
      </div>
      <button class="add-to-bag-btn" id="addToBagBtn">
        <span>Add to Bag</span>
        <span class="btn-price" id="addToBagPrice"></span>
      </button>
    </div>
  </div>
</div>

<!-- â”€â”€ LOYALTY BOTTOM-SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="loyalty-overlay" id="loyaltyOverlay">
  <div class="loyalty-sheet" id="loyaltySheet">
    <div class="loyalty-sheet-handle"></div>
    <div id="loyaltySheetContent"></div>
  </div>
</div>

<!-- â”€â”€ BAG PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="bag-overlay" id="bagOverlay">
  <div class="bag-panel" id="bagPanel">
    <div class="bag-header">
      <div class="bag-title" id="bagTitle">ğŸ› Takeout Bag</div>
      <button class="bag-loyalty-btn hidden" id="bagLoyaltyBtn" aria-label="Loyalty programme">â­</button>
      <button class="bag-close" id="bagClose" aria-label="Close bag">Ã—</button>
    </div>
    <div id="bagNameRow" class="bag-name-row"></div>
    <div class="bag-items" id="bagItems"></div>
    <div class="bag-footer" id="bagFooter" style="display:none;">
      <div class="bag-subtotal">
        <span>Total<span class="bag-item-count" id="bagItemCount"></span></span>
        <span class="subtotal-val" id="bagSubtotal"></span>
      </div>
      <!-- Favourite order checkbox â€” only shown when loyalty name is set -->
      <div class="bag-fav-row" id="bagFavRow" style="display:none;">
        <input type="checkbox" id="bagFavCheck">
        <label for="bagFavCheck">Save as my Favourite Order â­</label>
      </div>
      <div class="bag-actions">
        <button class="place-order-btn" id="placeOrderBtn">Place Order</button>
        <button class="clear-bag-btn" id="clearBagBtn">Clear Bag</button>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€ ORDER CONFIRMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="confirm-screen" id="confirmScreen">
  <div class="confirm-check">âœ…</div>
  <div class="confirm-order-label">Your Order</div>
  <div class="confirm-order-number" id="confirmNumber">#1234</div>
  <div class="confirm-tagline" id="confirmTagline">Your order has been received.<br>We'll call your number when it's ready!</div>
  <div class="confirm-items" id="confirmItems"></div>
  <div class="confirm-status-bar" id="confirmStatusBar"></div>
  <button class="new-order-btn" id="newOrderBtn">Start New Order</button>
</div>

<script type="module">
// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { initializeApp }                      from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, onSnapshot,
         collection, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyDrUKPNep2uxbZjYJ4i0vImdG7Xn_UuSXo",
  authDomain:        "rob-ph-demos.firebaseapp.com",
  projectId:         "rob-ph-demos",
  storageBucket:     "rob-ph-demos.firebasestorage.app",
  messagingSenderId: "199417645406",
  appId:             "1:199417645406:web:0e7a54d00083b41ea9e7cf"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

// â”€â”€ URL PARAMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const urlParams   = new URLSearchParams(window.location.search);
const STORE_CODE  = (urlParams.get('store')  || '').trim().toUpperCase();
const DEVICE_UDID = (urlParams.get('device') || '').trim();
const HOST_HEADER_HEIGHT = Math.min(parseInt(urlParams.get('headerHeight') || '0', 10) || 0, 200);
if (HOST_HEADER_HEIGHT > 0) {
  document.documentElement.style.setProperty('--host-header-height', HOST_HEADER_HEIGHT + 'px');
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _items       = [];
let _settings    = { restaurantName: 'Menu', currency: '$', logo: '' };
let _brands      = [];
let _stock       = {};
let _activeCat   = 'All';
let _searchQuery = '';
let _clearBagConfirming = false;
let _campaignFirstName = null;

// â”€â”€ LOYALTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _loyaltyName           = localStorage.getItem('loyalty_name') || null;
let _loyaltyEditMode       = false;   // true when updating name in loyalty sheet
let _loyaltyPopupDismissed = false;   // true when user dismisses FAB popup this session

// Current modal state
let _modalItem   = null;
let _modalQty    = 1;
let _modalRemovedIngredients = new Set();
let _modalAddedIngredients   = new Set();
let _modalSize   = null;
let _modalMilk   = null;

// Cart
let _bag = [];
let _queueUnsub = null;  // unsubscribe for queue status listener

// â”€â”€ PERSONALISATION HUB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _tokenCache = null;

async function _deriveKey() {
  if (_tokenCache) return;
  const enc  = new TextEncoder();
  const base = await crypto.subtle.importKey('raw', enc.encode('rob-ph-demos-phapi-v1'),
    'PBKDF2', false, ['deriveKey']);
  const key  = await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt: enc.encode('ph-menuboard-salt-2024'), iterations: 100000, hash: 'SHA-256' },
    base, { name: 'AES-GCM', length: 256 }, false, ['decrypt']
  );
  _tokenCache = { b64: null, plain: null, key };
}

async function decryptToken(b64) {
  await _deriveKey();
  if (_tokenCache.b64 === b64) return _tokenCache.plain;
  const raw  = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  const iv   = raw.slice(0, 12);
  const data = raw.slice(12);
  const dec  = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, _tokenCache.key, data);
  const plain = new TextDecoder().decode(dec);
  _tokenCache.b64 = b64; _tokenCache.plain = plain;
  return plain;
}

async function pollCampaign() {
  if (!DEVICE_UDID) return;
  const phApi = _settings.phApi;
  if (!phApi?.baseUrl || !phApi?.authToken) return;
  try {
    const token = await decryptToken(phApi.authToken);
    const url   = `${phApi.baseUrl}/location-api/device/${DEVICE_UDID}/campaign_data`;
    const resp  = await fetch(url, { headers: { accept: 'application/json', 'x-api-key': token } });
    if (!resp.ok) return;
    const json      = await resp.json();
    const firstName = (json?.data?.visitor_customer?.first_name || '').trim() || null;
    if (firstName !== _campaignFirstName) {
      _campaignFirstName = firstName;
      renderGreeting();
    }
  } catch (e) { /* silent */ }
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cur(n) {
  const c = _settings.currency || '$';
  return `${c}${Number(n).toFixed(2)}`;
}
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function isOos(sku) { return !!(STORE_CODE && _stock[sku] && _stock[sku].outOfStock); }

// â”€â”€ RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderGreeting() {
  const banner    = document.getElementById('greetingBanner');
  const content   = document.querySelector('.main-content');
  // Loyalty name takes priority over campaign API name
  const firstName = _loyaltyName || _campaignFirstName;
  if (firstName) {
    banner.textContent = `Hi ${firstName}, what can we get for you today? ğŸ‘‹`;
    banner.style.display = '';
    if (content) content.classList.add('has-greeting');
  } else {
    banner.style.display = 'none';
    if (content) content.classList.remove('has-greeting');
  }
}

// â”€â”€ LOYALTY FUNCTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getSavedFavouriteOrder() {
  try {
    const raw = localStorage.getItem('loyalty_order');
    return raw ? JSON.parse(raw) : null;
  } catch (e) {
    return null;
  }
}

function updateFabPopup() {
  const popup  = document.getElementById('fabPopup');
  const textEl = document.getElementById('fabPopupText');
  if (!popup || !textEl) return;
  const savedOrder = getSavedFavouriteOrder();
  const show = _loyaltyName
    && savedOrder && savedOrder.length > 0
    && _bag.length === 0
    && !_loyaltyPopupDismissed;
  if (show) {
    textEl.textContent = `Hi ${_loyaltyName}! Your favourite order is ready â€” add it again?`;
    popup.classList.add('visible');
  } else {
    popup.classList.remove('visible');
  }
}

function loadFavouriteOrderIntoBag() {
  const savedOrder = getSavedFavouriteOrder();
  if (!savedOrder || !savedOrder.length) return;
  savedOrder.forEach(item => {
    _bag.push({ ...item, uid: Date.now() + Math.random() });
  });
  renderBagPanel();
  updateBagBadge();
  syncCartToFirestore();
  document.getElementById('fabPopup').classList.remove('visible');
  openBag();
}

function renderLoyaltySheet() {
  const content = document.getElementById('loyaltySheetContent');
  if (!content) return;
  if (!_loyaltyName || _loyaltyEditMode) {
    // State A: No name saved â€” show input form
    _loyaltyEditMode = false;
    content.innerHTML = `
      <div class="loyalty-sheet-title">Loyalty Programme</div>
      <div class="loyalty-greeting-text">Save your name so we can greet you personally and quickly re-order your favourites!</div>
      <input class="loyalty-name-input" id="loyaltyNameInput" type="text"
             placeholder="Enter your first name" maxlength="40" autocomplete="given-name">
      <button class="loyalty-save-btn" id="loyaltySaveBtn" disabled>Save My Name</button>
    `;
    const input = document.getElementById('loyaltyNameInput');
    const btn   = document.getElementById('loyaltySaveBtn');
    input.addEventListener('input', () => { btn.disabled = !input.value.trim(); });
    btn.addEventListener('click', () => {
      const name = input.value.trim();
      if (!name) return;
      saveLoyaltyName(name);
      closeLoyaltySheet();
    });
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && input.value.trim()) {
        saveLoyaltyName(input.value.trim());
        closeLoyaltySheet();
      }
    });
    setTimeout(() => input.focus(), 300);
  } else {
    // State B: Name exists â€” show profile + saved order
    const savedOrder = getSavedFavouriteOrder();
    const favHtml = savedOrder && savedOrder.length
      ? `<div class="loyalty-fav-summary">
           <strong>Your Favourite Order:</strong>
           ${savedOrder.map(r => `${r.qty}&times; ${esc(r.name)}`).join('<br>')}
         </div>`
      : `<div class="loyalty-fav-summary" style="font-style:italic;">
           No favourite order saved yet.<br>Place an order and tick <em>"Save as Favourite"</em>.
         </div>`;
    content.innerHTML = `
      <div class="loyalty-hi-text">Hi ${esc(_loyaltyName)}! ğŸ‘‹</div>
      ${favHtml}
      <button class="loyalty-update-name" id="loyaltyUpdateNameBtn">Update my name</button>
      <button class="loyalty-forget-btn" id="loyaltyForgetBtn">Forget Me</button>
    `;
    document.getElementById('loyaltyUpdateNameBtn').addEventListener('click', () => {
      _loyaltyEditMode = true;
      renderLoyaltySheet();
    });
    document.getElementById('loyaltyForgetBtn').addEventListener('click', () => {
      forgetLoyalty();
      closeLoyaltySheet();
    });
  }
}

function openLoyaltySheet() {
  renderLoyaltySheet();
  document.getElementById('loyaltyOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeLoyaltySheet() {
  _loyaltyEditMode = false;
  document.getElementById('loyaltyOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

function saveLoyaltyName(name) {
  _loyaltyName = name;
  localStorage.setItem('loyalty_name', name);
  renderGreeting();
  syncCartToFirestore(); // push customerName to Firestore immediately
  renderBagPanel();      // show favourite checkbox
  updateFabPopup();
}

function forgetLoyalty() {
  _loyaltyName = null;
  _loyaltyEditMode = false;
  _loyaltyPopupDismissed = false;
  localStorage.removeItem('loyalty_name');
  localStorage.removeItem('loyalty_order');
  renderGreeting();
  syncCartToFirestore();
  renderBagPanel();
  updateFabPopup();
}

function applyBranding() {
  const brand = _brands[0];
  const s = _settings;
  const name = brand?.name || s.restaurantName || 'Menu';
  document.getElementById('headerTitle').textContent = name;
  document.title = `Order â€” ${name}`;

  const logo = brand?.logo || s.logo || '';
  const logoEl = document.getElementById('headerLogo');
  if (logo) {
    logoEl.innerHTML = `<img src="${esc(logo)}" alt="${esc(name)}" style="width:38px;height:38px;border-radius:50%;object-fit:contain;">`;
    logoEl.className = 'logo';
  }

  const colors = brand?.colors || s.colors || {};
  const catBarEl = document.querySelector('.cat-bar');
  if (colors.accent) {
    if (catBarEl) catBarEl.style.background = colors.accent;
  }
  if (colors.catBar && catBarEl) catBarEl.style.background = colors.catBar;
  // Also tint the greeting banner
  const greetBanner = document.getElementById('greetingBanner');
  if (greetBanner) {
    if (colors.header)  greetBanner.style.background = colors.header;
    else if (colors.accent) greetBanner.style.background = colors.accent;
  }
  if (colors.body)    document.documentElement.style.setProperty('--body', colors.body);
  if (colors.text)    document.documentElement.style.setProperty('--text', colors.text);
  if (colors.price)   document.documentElement.style.setProperty('--green-dark', colors.price);

  const bagLabel = brand?.bagLabel || 'Takeout Bag';
  const bagIcon  = brand?.bagIcon  || '';
  const bagTitleEl = document.getElementById('bagTitle');
  if (bagTitleEl) {
    if (bagIcon) {
      bagTitleEl.innerHTML = `<img src="${esc(bagIcon)}" alt="" style="width:28px;height:28px;object-fit:contain;vertical-align:middle;margin-right:8px;">${esc(bagLabel)}`;
    } else {
      bagTitleEl.textContent = `ğŸ› ${bagLabel}`;
    }
  }
}

function getFilteredItems() {
  const q = _searchQuery.trim().toLowerCase();
  return _items.filter(i => {
    if (!i.active) return false;
    // When a search query is active, search across ALL categories
    if (!q && _activeCat !== 'All' && i.category !== _activeCat) return false;
    if (q) {
      const haystack = `${i.name} ${i.description || ''} ${i.category}`.toLowerCase();
      if (!haystack.includes(q)) return false;
    }
    return true;
  });
}

function renderCatBar() {
  const rawCats = [...new Set(_items.filter(i => i.active).map(i => i.category))];
  const specials = rawCats.filter(c => c === "Today's Specials");
  const others   = rawCats.filter(c => c !== "Today's Specials");
  const cats     = ['All', ...specials, ...others];
  const bar  = document.getElementById('catBar');
  bar.innerHTML = cats.map(c => `
    <button class="cat-tab${c === _activeCat ? ' active' : ''}" data-cat="${esc(c)}">${esc(c)}</button>
  `).join('');
  bar.querySelectorAll('.cat-tab').forEach(btn => {
    btn.addEventListener('click', () => {
      _activeCat = btn.dataset.cat;
      // Clear search when switching categories
      if (_searchQuery) {
        _searchQuery = '';
        const inp = document.getElementById('searchInput');
        const clr = document.getElementById('searchClear');
        if (inp) inp.value = '';
        if (clr) clr.classList.remove('visible');
      }
      renderCatBar();
      renderItemsGrid();
    });
  });
}

function renderItemsGrid() {
  const grid    = document.getElementById('itemsGrid');
  const loading = document.getElementById('loadingState');
  const label   = document.getElementById('searchResultsLabel');
  const items   = getFilteredItems();
  const q       = _searchQuery.trim();

  loading.style.display = 'none';
  grid.style.display    = '';

  // Show search results label when searching
  if (q && label) {
    label.style.display = '';
    label.innerHTML = items.length
      ? `Showing <strong>${items.length}</strong> result${items.length !== 1 ? 's' : ''} for "<strong>${esc(q)}</strong>"`
      : '';
  } else if (label) {
    label.style.display = 'none';
  }

  if (!items.length) {
    grid.innerHTML = `<div class="state-screen" style="grid-column:1/-1;min-height:40dvh;">
      <div class="state-icon">${q ? 'ğŸ”' : 'ğŸ½'}</div>
      <h2>${q ? 'No Results' : 'Nothing here'}</h2>
      <p>${q ? `No items matching "<strong>${esc(q)}</strong>"` : 'No items in this category right now.'}</p>
    </div>`;
    return;
  }

  grid.innerHTML = items.map(item => {
    const oos = isOos(item.sku);
    const img = item.images?.[0] || '';
    return `
    <div class="item-card${oos ? ' oos' : ''}" data-sku="${esc(item.sku)}">
      ${oos ? '<span class="oos-badge">Sold Out</span>' : ''}
      <div class="thumb-placeholder">
        ${img ? `<img src="${esc(img)}" alt="${esc(item.name)}" loading="lazy">` : ''}
      </div>
      <div class="card-body">
        <div class="card-cat">${esc(item.category)}</div>
        <div class="card-name">${esc(item.name)}</div>
        <div class="card-footer">
          <div class="card-price">${cur(item.price)}</div>
          <button class="add-icon" data-sku="${esc(item.sku)}" aria-label="Add ${esc(item.name)} to bag">+ADD</button>
        </div>
      </div>
    </div>`;
  }).join('');

  grid.querySelectorAll('.item-card:not(.oos)').forEach(card => {
    const item = _items.find(i => i.sku === card.dataset.sku);
    if (!item) return;
    const addBtn = card.querySelector('.add-icon');
    if (addBtn) {
      addBtn.addEventListener('click', e => {
        e.stopPropagation();
        if (hasCustomization(item)) openModal(item);
        else addItemDirectly(item);
      });
    }
    card.addEventListener('click', () => openModal(item));
  });
}

function renderAll() {
  applyBranding();
  renderCatBar();
  renderItemsGrid();
  renderGreeting();
}

// â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function computeModalTotal() {
  if (!_modalItem) return 0;
  let price = _modalItem.price;
  const c = _modalItem.customization || {};
  if (_modalSize && c.sizes?.length) {
    const s = c.sizes.find(s => s.id === _modalSize);
    if (s) price += s.priceAdj;
  }
  if (_modalMilk && c.milkOptions?.length) {
    const m = c.milkOptions.find(m => m.id === _modalMilk);
    if (m) price += m.priceAdj;
  }
  (c.additions || []).forEach(a => {
    if (_modalAddedIngredients.has(a.id)) price += a.priceAdj;
  });
  return price * _modalQty;
}

function updateModalTotal() {
  const total = computeModalTotal();
  document.getElementById('addToBagPrice').textContent = cur(total);
}

function openModal(item) {
  _modalItem = item;
  _modalQty  = 1;
  _modalRemovedIngredients = new Set();
  _modalAddedIngredients   = new Set();

  const c = item.customization || {};

  _modalSize = c.defaultSize || (c.sizes?.[0]?.id ?? null);
  const defaultMilk = c.milkOptions?.find(m => m.default);
  _modalMilk = defaultMilk?.id ?? (c.milkOptions?.[0]?.id ?? null);

  const img = item.images?.[0] || '';
  document.getElementById('modalImg').innerHTML = img
    ? `<img src="${esc(img)}" alt="${esc(item.name)}">`
    : '';

  document.getElementById('modalName').textContent       = item.name;
  document.getElementById('modalDesc').textContent       = item.description || '';
  document.getElementById('modalBasePrice').textContent  = cur(item.price);
  document.getElementById('qtyVal').textContent          = '1';

  // Sizes
  const sizesEl = document.getElementById('modalSizes');
  if (c.sizes?.length) {
    sizesEl.innerHTML = `
      <div class="modal-section">
        <div class="modal-section-title">Size</div>
        <div class="size-grid">
          ${c.sizes.map(s => `
            <label class="size-pill${s.id === _modalSize ? ' selected' : ''}">
              <input type="radio" name="ms-size" value="${esc(s.id)}">
              <div class="size-label">${esc(s.label)}</div>
              <div class="size-price">${s.priceAdj > 0 ? '+' : ''}${s.priceAdj !== 0 ? cur(Math.abs(s.priceAdj)) : 'Included'}</div>
            </label>`).join('')}
        </div>
      </div>`;
    sizesEl.querySelectorAll('.size-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        _modalSize = pill.querySelector('input').value;
        sizesEl.querySelectorAll('.size-pill').forEach(p => p.classList.toggle('selected', p === pill));
        updateModalTotal();
      });
    });
  } else {
    sizesEl.innerHTML = '';
  }

  // Milk
  const milkEl = document.getElementById('modalMilk');
  if (c.milkOptions?.length) {
    milkEl.innerHTML = `
      <div class="modal-section">
        <div class="modal-section-title">Milk</div>
        <div class="option-list">
          ${c.milkOptions.map(m => `
            <label class="option-row${m.id === _modalMilk ? ' selected' : ''}">
              <input type="radio" name="ms-milk" value="${esc(m.id)}">
              <span class="opt-label">${esc(m.label)}</span>
              <span class="opt-price">${m.priceAdj > 0 ? `+${cur(m.priceAdj)}` : 'Included'}</span>
            </label>`).join('')}
        </div>
      </div>`;
    milkEl.querySelectorAll('.option-row').forEach(row => {
      row.addEventListener('click', () => {
        _modalMilk = row.querySelector('input').value;
        milkEl.querySelectorAll('.option-row').forEach(r => r.classList.toggle('selected', r === row));
        updateModalTotal();
      });
    });
  } else {
    milkEl.innerHTML = '';
  }

  // Default ingredients
  const ingEl = document.getElementById('modalIngredients');
  const removable = (c.defaultIngredients || []).filter(i => i.removable);
  const fixed     = (c.defaultIngredients || []).filter(i => !i.removable);
  if (c.defaultIngredients?.length) {
    ingEl.innerHTML = `
      <div class="modal-section">
        <div class="modal-section-title">Ingredients</div>
        <div class="ingredient-tags">
          ${fixed.map(i => `<div class="ingredient-tag"><span>${esc(i.label)}</span></div>`).join('')}
          ${removable.map(i => `
            <div class="ingredient-tag" data-ing-id="${esc(i.id)}">
              <span>${esc(i.label)}</span>
              <span class="ing-remove" title="Remove">Ã—</span>
            </div>`).join('')}
        </div>
      </div>`;
    ingEl.querySelectorAll('.ingredient-tag[data-ing-id]').forEach(tag => {
      tag.querySelector('.ing-remove').addEventListener('click', () => {
        const id = tag.dataset.ingId;
        if (_modalRemovedIngredients.has(id)) {
          _modalRemovedIngredients.delete(id);
          tag.classList.remove('removed');
        } else {
          _modalRemovedIngredients.add(id);
          tag.classList.add('removed');
        }
      });
    });
  } else {
    ingEl.innerHTML = '';
  }

  // Additions
  const addEl = document.getElementById('modalAddons');
  if (c.additions?.length) {
    addEl.innerHTML = `
      <div class="modal-section">
        <div class="modal-section-title">Add to your order</div>
        <div class="addon-list">
          ${c.additions.map(a => `
            <label class="addon-row" data-addon-id="${esc(a.id)}">
              <input type="checkbox" value="${esc(a.id)}">
              <div class="addon-check"></div>
              <span class="addon-label">${esc(a.label)}</span>
              <span class="addon-price${a.priceAdj === 0 ? ' free' : ''}">
                ${a.priceAdj > 0 ? `+${cur(a.priceAdj)}` : 'Free'}
              </span>
            </label>`).join('')}
        </div>
      </div>`;
    addEl.querySelectorAll('.addon-row').forEach(row => {
      row.addEventListener('click', () => {
        const id  = row.dataset.addonId;
        const chk = row.querySelector('input');
        chk.checked = !chk.checked;
        row.classList.toggle('checked', chk.checked);
        row.querySelector('.addon-check').textContent = chk.checked ? 'âœ“' : '';
        if (chk.checked) _modalAddedIngredients.add(id);
        else             _modalAddedIngredients.delete(id);
        updateModalTotal();
      });
    });
  } else {
    addEl.innerHTML = '';
  }

  updateModalTotal();

  document.getElementById('modalOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
  document.body.style.overflow = '';
  _modalItem = null;
}

// â”€â”€ BAG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function bagTotal() {
  return _bag.reduce((s, row) => s + row.lineTotal, 0);
}

function bagItemCount() {
  return _bag.reduce((s, r) => s + r.qty, 0);
}

function syncCartToFirestore(statusOverride, orderNumber) {
  if (!DEVICE_UDID || !STORE_CODE) return;
  const payload = {
    storeCode:    STORE_CODE,
    items:        _bag,
    total:        bagTotal(),
    itemCount:    bagItemCount(),
    updatedAt:    serverTimestamp(),
    status:       statusOverride || 'active',
    customerName: _loyaltyName || _campaignFirstName || ''
  };
  if (orderNumber !== undefined) payload.orderNumber = orderNumber;
  if (statusOverride === 'completed') {
    payload.queueStatus    = 'waiting';
    payload.queueEnteredAt = new Date().toISOString();
  }
  setDoc(doc(db, 'carts', DEVICE_UDID), payload)
    .catch(e => console.warn('[Cart sync] failed:', e));
}

function hasCustomization(item) {
  const c = item.customization || {};
  return !!(c.sizes?.length || c.milkOptions?.length || c.additions?.length
            || c.defaultIngredients?.some(i => i.removable));
}

function addItemDirectly(item) {
  // Consolidate with existing identical entry (same SKU, no customisation)
  const existing = _bag.find(r =>
    r.sku === item.sku && !r.size && !r.milk &&
    r.addedIngredients.length === 0 && r.removedIngredients.length === 0
  );
  if (existing) {
    existing.qty++;
    existing.lineTotal = existing.unitPrice * existing.qty;
  } else {
    _bag.push({
      uid:                Date.now() + Math.random(),
      sku:                item.sku,
      name:               item.name,
      basePrice:          item.price,
      size:               null,
      milk:               null,
      removedIngredients: [],
      addedIngredients:   [],
      qty:                1,
      unitPrice:          item.price,
      lineTotal:          item.price
    });
  }
  renderBagPanel();
  updateBagBadge();
  syncCartToFirestore();
}

function updateBagBadge() {
  const n   = bagItemCount();
  const bdg = document.getElementById('bagBadge');
  bdg.textContent = n;
  bdg.classList.toggle('visible', n > 0);
  updateFabPopup();
}

function addToBag() {
  if (!_modalItem) return;
  const c    = _modalItem.customization || {};
  let price  = _modalItem.price;

  const sizeObj = c.sizes?.find(s => s.id === _modalSize);
  const milkObj = c.milkOptions?.find(m => m.id === _modalMilk);
  if (sizeObj) price += sizeObj.priceAdj;
  if (milkObj) price += milkObj.priceAdj;

  const addedList = (c.additions || []).filter(a => _modalAddedIngredients.has(a.id));
  addedList.forEach(a => { price += a.priceAdj; });

  const resolvedSize    = sizeObj?.label  || null;
  const resolvedMilk    = milkObj?.label  || null;
  const resolvedRemoved = [..._modalRemovedIngredients].map(id => {
    const ing = c.defaultIngredients?.find(i => i.id === id);
    return ing?.label || id;
  });
  const resolvedAdded = addedList.map(a => a.label);

  // Consolidate with existing identical entry (same SKU + same customisation)
  const existing = _bag.find(r =>
    r.sku === _modalItem.sku &&
    r.size === resolvedSize &&
    r.milk === resolvedMilk &&
    r.unitPrice === price &&
    JSON.stringify([...r.removedIngredients].sort()) === JSON.stringify([...resolvedRemoved].sort()) &&
    JSON.stringify([...r.addedIngredients].sort())   === JSON.stringify([...resolvedAdded].sort())
  );

  if (existing) {
    existing.qty      += _modalQty;
    existing.lineTotal = existing.unitPrice * existing.qty;
  } else {
    const row = {
      uid:                Date.now() + Math.random(),
      sku:                _modalItem.sku,
      name:               _modalItem.name,
      basePrice:          _modalItem.price,
      size:               resolvedSize,
      milk:               resolvedMilk,
      removedIngredients: resolvedRemoved,
      addedIngredients:   resolvedAdded,
      qty:                _modalQty,
      unitPrice:          price,
      lineTotal:          price * _modalQty
    };
    _bag.push(row);
  }
  renderBagPanel();
  updateBagBadge();
  syncCartToFirestore();
  closeModal();
}

function renderBagNameRow() {
  const nameRowEl = document.getElementById('bagNameRow');
  const starBtn   = document.getElementById('bagLoyaltyBtn');
  if (!nameRowEl) return;

  if (!_loyaltyName) {
    // No name yet â€” show input form
    nameRowEl.innerHTML = `
      <div class="bag-name-row-label">Your Name</div>
      <div class="bag-name-input-row">
        <input class="bag-name-input" id="bagNameInput" type="text"
               placeholder="Enter your first nameâ€¦" maxlength="40" autocomplete="given-name">
        <button class="bag-name-save-btn" id="bagNameSaveBtn" disabled>Save</button>
      </div>`;
    starBtn && starBtn.classList.add('hidden');
    const input = nameRowEl.querySelector('#bagNameInput');
    const btn   = nameRowEl.querySelector('#bagNameSaveBtn');
    input.addEventListener('input', () => { btn.disabled = !input.value.trim(); });
    btn.addEventListener('click', () => {
      const name = input.value.trim();
      if (!name) return;
      saveLoyaltyName(name);
    });
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && input.value.trim()) saveLoyaltyName(input.value.trim());
    });
  } else {
    // Name saved â€” show greeting + Forget Me
    nameRowEl.innerHTML = `
      <div class="bag-name-greeting">
        <span class="bag-name-greeting-text">Hi ${esc(_loyaltyName)}! â­</span>
        <button class="bag-name-forget-btn" id="bagNameForgetBtn">Forget Me</button>
      </div>`;
    starBtn && starBtn.classList.remove('hidden');
    nameRowEl.querySelector('#bagNameForgetBtn').addEventListener('click', forgetLoyalty);
  }
}

function renderBagPanel() {
  renderBagNameRow();
  const itemsEl  = document.getElementById('bagItems');
  const footerEl = document.getElementById('bagFooter');
  const subtotal = document.getElementById('bagSubtotal');
  const countEl  = document.getElementById('bagItemCount');

  if (!_bag.length) {
    itemsEl.innerHTML = `
      <div class="bag-empty">
        <div class="empty-icon">ğŸ›</div>
        <p>Your bag is empty.<br>Add something delicious!</p>
      </div>`;
    footerEl.style.display = 'none';
    return;
  }

  itemsEl.innerHTML = _bag.map(row => {
    const mods = [];
    if (row.size)                        mods.push(row.size);
    if (row.milk)                        mods.push(row.milk);
    if (row.removedIngredients.length)   mods.push('No ' + row.removedIngredients.join(', No '));
    if (row.addedIngredients.length)     mods.push('+ ' + row.addedIngredients.join(', + '));
    return `
    <div class="bag-item-row" data-uid="${row.uid}">
      <div class="bag-item-top">
        <div class="bag-item-name">${esc(row.name)}</div>
        <div class="bag-item-line-total">${cur(row.lineTotal)}</div>
      </div>
      ${mods.length ? `<div class="bag-item-mods">${esc(mods.join(' Â· '))}</div>` : ''}
      <div class="bag-item-actions">
        <div class="bag-qty-control">
          <button class="bag-qty-btn" data-action="minus">âˆ’</button>
          <span class="bag-qty-val">${row.qty}</span>
          <button class="bag-qty-btn" data-action="plus">+</button>
        </div>
        <button class="bag-remove-btn">Remove</button>
      </div>
    </div>`;
  }).join('');

  itemsEl.querySelectorAll('.bag-item-row').forEach(rowEl => {
    const uid = Number(rowEl.dataset.uid);
    rowEl.querySelector('[data-action="plus"]').addEventListener('click', () => adjustBagQty(uid, 1));
    rowEl.querySelector('[data-action="minus"]').addEventListener('click', () => adjustBagQty(uid, -1));
    rowEl.querySelector('.bag-remove-btn').addEventListener('click', () => removeBagItem(uid));
  });

  const total     = bagTotal();
  const itemCount = bagItemCount();
  subtotal.textContent = cur(total);
  if (countEl) countEl.textContent = ` (${itemCount} item${itemCount !== 1 ? 's' : ''})`;
  footerEl.style.display = '';
  // Show Save as Favourite checkbox only when a loyalty name is set
  const favRow = document.getElementById('bagFavRow');
  if (favRow) favRow.style.display = _loyaltyName ? '' : 'none';
}

function adjustBagQty(uid, delta) {
  const row = _bag.find(r => r.uid === uid);
  if (!row) return;
  row.qty = Math.max(1, row.qty + delta);
  row.lineTotal = row.unitPrice * row.qty;
  renderBagPanel();
  updateBagBadge();
  syncCartToFirestore();
}

function removeBagItem(uid) {
  _bag = _bag.filter(r => r.uid !== uid);
  renderBagPanel();
  updateBagBadge();
  syncCartToFirestore();
}

function openBag() {
  renderBagPanel();
  document.getElementById('bagOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeBag() {
  _clearBagConfirming = false;
  const btn = document.getElementById('clearBagBtn');
  if (btn) { btn.textContent = 'Clear Bag'; btn.classList.remove('confirming'); }
  document.getElementById('bagOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

function clearBag() {
  const btn = document.getElementById('clearBagBtn');
  if (!_clearBagConfirming) {
    _clearBagConfirming = true;
    btn.textContent = 'Confirm Clear?';
    btn.classList.add('confirming');
    setTimeout(() => {
      if (_clearBagConfirming) {
        _clearBagConfirming = false;
        btn.textContent = 'Clear Bag';
        btn.classList.remove('confirming');
      }
    }, 3000);
  } else {
    _clearBagConfirming = false;
    btn.textContent = 'Clear Bag';
    btn.classList.remove('confirming');
    _bag = [];
    syncCartToFirestore('cleared');
    renderBagPanel();
    updateBagBadge();
  }
}

// â”€â”€ ORDER CONFIRMATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function placeOrder() {
  if (!_bag.length) return;
  // Save as favourite if checkbox is ticked and loyalty name is set
  if (_loyaltyName) {
    const favCheck = document.getElementById('bagFavCheck');
    if (favCheck && favCheck.checked) {
      localStorage.setItem('loyalty_order', JSON.stringify(_bag));
      favCheck.checked = false;
    }
  }
  const orderNumber = String(Math.floor(Math.random() * 9000) + 1000);
  syncCartToFirestore('completed', orderNumber);
  closeBag();

  document.getElementById('confirmNumber').textContent = `#${orderNumber}`;

  const itemsEl = document.getElementById('confirmItems');
  const total   = bagTotal();
  itemsEl.innerHTML = _bag.map(row => `
    <div class="confirm-item">
      <span><span class="ci-qty">${row.qty}Ã—</span> ${esc(row.name)}${row.size ? ` (${esc(row.size)})` : ''}</span>
      <span>${cur(row.lineTotal)}</span>
    </div>`).join('') +
    `<div class="confirm-total"><span>Total</span><span>${cur(total)}</span></div>`;

  document.getElementById('confirmScreen').classList.add('open');
  document.body.style.overflow = 'hidden';

  // Start queue status listener for mobile status updates
  if (DEVICE_UDID) {
    if (_queueUnsub) { _queueUnsub(); _queueUnsub = null; }
    const statusBar = document.getElementById('confirmStatusBar');
    const STATUS_LABELS = {
      'waiting':     'â³ Your order is in the queue',
      'in-progress': 'ğŸ‘¨â€ğŸ³ Your order is being prepared',
      'ready':       'ğŸ‰ Ready for Collection!'
    };
    _queueUnsub = onSnapshot(doc(db, 'carts', DEVICE_UDID), snap => {
      const qs = snap.exists() ? snap.data().queueStatus : null;
      if (qs && STATUS_LABELS[qs]) {
        statusBar.textContent = STATUS_LABELS[qs];
        statusBar.classList.add('visible');
      } else {
        statusBar.classList.remove('visible');
      }
    });
    // Auto-unsubscribe after 10 minutes
    setTimeout(() => { if (_queueUnsub) { _queueUnsub(); _queueUnsub = null; } }, 10 * 60 * 1000);
  }
}

function startNewOrder() {
  if (_queueUnsub) { _queueUnsub(); _queueUnsub = null; }
  _bag = [];
  syncCartToFirestore('cleared');
  updateBagBadge(); // also calls updateFabPopup via updateBagBadge
  document.getElementById('confirmScreen').classList.remove('open');
  document.body.style.overflow = '';
}

// â”€â”€ FIRESTORE LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onSnapshot(collection(db, 'items'), snap => {
  _items = snap.docs.map(d => d.data()).sort((a,b) =>
    (a.createdAt||'').localeCompare(b.createdAt||''));
  renderAll();
});

onSnapshot(doc(db, 'menuboard', 'brands'), snap => {
  _brands = snap.exists() ? (snap.data().data || []) : [];
  applyBranding();
});

onSnapshot(doc(db, 'menuboard', 'settings'), snap => {
  _settings = snap.exists() ? snap.data()
    : { restaurantName: 'Menu', currency: '$', logo: '' };
  applyBranding();
  if (DEVICE_UDID) pollCampaign();
});

if (STORE_CODE) {
  onSnapshot(doc(db, 'stock', STORE_CODE), snap => {
    _stock = snap.exists() ? snap.data() : {};
    renderItemsGrid();
  });
}

// â”€â”€ EVENT WIRING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NOTE: type="module" scripts run deferred (after DOM is parsed), so
// DOMContentLoaded has already fired â€” wire events directly here.

// Modal
document.getElementById('modalClose').addEventListener('click', closeModal);
document.getElementById('modalOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
});
document.getElementById('qtyMinus').addEventListener('click', () => {
  _modalQty = Math.max(1, _modalQty - 1);
  document.getElementById('qtyVal').textContent = _modalQty;
  updateModalTotal();
});
document.getElementById('qtyPlus').addEventListener('click', () => {
  _modalQty++;
  document.getElementById('qtyVal').textContent = _modalQty;
  updateModalTotal();
});
document.getElementById('addToBagBtn').addEventListener('click', addToBag);

// Bag
document.getElementById('bagBtn').addEventListener('click', openBag);
document.getElementById('bagClose').addEventListener('click', closeBag);
document.getElementById('bagOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('bagOverlay')) closeBag();
});
document.getElementById('placeOrderBtn').addEventListener('click', placeOrder);
document.getElementById('clearBagBtn').addEventListener('click', clearBag);

// Loyalty sheet
document.getElementById('bagLoyaltyBtn').addEventListener('click', openLoyaltySheet);
document.getElementById('loyaltyOverlay').addEventListener('click', e => {
  if (e.target === document.getElementById('loyaltyOverlay')) closeLoyaltySheet();
});

// FAB popup
document.getElementById('fabPopupClose').addEventListener('click', e => {
  e.stopPropagation();
  _loyaltyPopupDismissed = true;
  document.getElementById('fabPopup').classList.remove('visible');
});
document.getElementById('fabPopupAddBtn').addEventListener('click', loadFavouriteOrderIntoBag);

// Confirmation
document.getElementById('newOrderBtn').addEventListener('click', startNewOrder);

// Search
const searchInput = document.getElementById('searchInput');
const searchClear = document.getElementById('searchClear');

searchInput.addEventListener('input', () => {
  _searchQuery = searchInput.value;
  searchClear.classList.toggle('visible', _searchQuery.length > 0);
  renderItemsGrid();
});

searchClear.addEventListener('click', () => {
  _searchQuery = '';
  searchInput.value = '';
  searchInput.focus();
  searchClear.classList.remove('visible');
  renderItemsGrid();
});

// Campaign polling (if device UDID present)
if (DEVICE_UDID) {
  _deriveKey();
  pollCampaign();
  setInterval(pollCampaign, 5000);
}

// Loyalty: show greeting + popup for returning users on page load
renderGreeting();
updateFabPopup();
</script>
</body>
</html>
