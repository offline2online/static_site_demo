<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Progress Board</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --green:    #006241;
    --green2:   #00a86b;
    --gold:     #CBA135;
    --cream:    #FAF7F2;
    --white:    #ffffff;
    --text:     #1E293B;
    --text2:    #64748B;
    --border:   #E2E8F0;
    --surface:  #ffffff;
    --waiting-bg:     #FFF7ED;
    --waiting-border: #FED7AA;
    --waiting-accent: #EA580C;
    --progress-bg:    #EFF6FF;
    --progress-border:#BFDBFE;
    --progress-accent:#2563EB;
    --ready-bg:       #F0FDF4;
    --ready-border:   #BBF7D0;
    --ready-accent:   #16A34A;
    --radius: 12px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; overflow: hidden; background: var(--cream); }
  body {
    font-family: 'Inter', sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  /* ── HEADER ─────────────────────────── */
  .board-header {
    background: var(--green);
    color: var(--white);
    padding: 0 32px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .board-title {
    font-family: 'Oswald', sans-serif;
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 0.5px;
  }
  .board-store {
    font-size: 13px;
    opacity: 0.75;
    font-weight: 600;
    letter-spacing: 0.3px;
  }
  .board-clock {
    font-family: 'Oswald', sans-serif;
    font-size: 20px;
    font-weight: 400;
    opacity: 0.9;
  }

  /* ── COLUMNS ────────────────────────── */
  .board-body {
    flex: 1;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    padding: 20px 24px;
    overflow: hidden;
  }
  .col {
    display: flex;
    flex-direction: column;
    background: var(--surface);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
  }
  .col-header {
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border);
  }
  .col-header.waiting   { background: var(--waiting-bg);  border-bottom-color: var(--waiting-border); }
  .col-header.progress  { background: var(--progress-bg); border-bottom-color: var(--progress-border); }
  .col-header.ready     { background: var(--ready-bg);    border-bottom-color: var(--ready-border); }

  .col-icon { font-size: 20px; }
  .col-title {
    font-family: 'Oswald', sans-serif;
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 0.4px;
    flex: 1;
  }
  .col-title.waiting  { color: var(--waiting-accent); }
  .col-title.progress { color: var(--progress-accent); }
  .col-title.ready    { color: var(--ready-accent); }
  .col-count {
    font-size: 12px;
    font-weight: 700;
    padding: 2px 9px;
    border-radius: 20px;
    min-width: 24px;
    text-align: center;
  }
  .col-count.waiting  { background: var(--waiting-accent);  color: var(--white); }
  .col-count.progress { background: var(--progress-accent); color: var(--white); }
  .col-count.ready    { background: var(--ready-accent);    color: var(--white); }

  .col-cards {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .col-cards:empty::after {
    content: 'No orders';
    display: block;
    text-align: center;
    color: var(--text2);
    font-size: 13px;
    padding: 24px 0;
  }

  /* ── ORDER CARD ──────────────────────── */
  .order-card {
    border-radius: 10px;
    border: 1.5px solid;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn .3s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .order-card.waiting  { background: var(--waiting-bg);  border-color: var(--waiting-border); }
  .order-card.progress { background: var(--progress-bg); border-color: var(--progress-border); }
  .order-card.ready    { background: var(--ready-bg);    border-color: var(--ready-border); }
  .order-card.ready    { animation: pulse 2s ease-in-out infinite; }
  @keyframes pulse {
    0%, 100% { border-color: var(--ready-border); }
    50%      { border-color: var(--ready-accent); }
  }

  .card-number {
    font-family: 'Oswald', sans-serif;
    font-size: 22px;
    font-weight: 700;
    flex-shrink: 0;
    min-width: 56px;
  }
  .card-number.waiting  { color: var(--waiting-accent); }
  .card-number.progress { color: var(--progress-accent); }
  .card-number.ready    { color: var(--ready-accent); }

  .card-info { flex: 1; min-width: 0; }
  .card-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .card-items {
    font-size: 11px;
    color: var(--text2);
    margin-top: 2px;
  }

  /* ── NO-STORE OVERLAY ────────────────── */
  .no-store {
    position: fixed; inset: 0;
    background: var(--green);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    gap: 12px;
    color: var(--white);
    font-family: 'Oswald', sans-serif;
  }
  .no-store h1 { font-size: 28px; font-weight: 700; }
  .no-store p  { font-size: 16px; opacity: .75; }
</style>
</head>
<body>

<div class="board-header">
  <div>
    <div class="board-title">&#x1F4CB; Order Progress</div>
    <div class="board-store" id="boardStore"></div>
  </div>
  <div class="board-clock" id="boardClock"></div>
</div>

<div class="board-body">
  <!-- Waiting -->
  <div class="col">
    <div class="col-header waiting">
      <span class="col-icon">&#x23F3;</span>
      <span class="col-title waiting">Waiting</span>
      <span class="col-count waiting" id="countWaiting">0</span>
    </div>
    <div class="col-cards" id="colWaiting"></div>
  </div>

  <!-- In Progress -->
  <div class="col">
    <div class="col-header progress">
      <span class="col-icon">&#x1F373;</span>
      <span class="col-title progress">In Progress</span>
      <span class="col-count progress" id="countProgress">0</span>
    </div>
    <div class="col-cards" id="colProgress"></div>
  </div>

  <!-- Ready -->
  <div class="col">
    <div class="col-header ready">
      <span class="col-icon">&#x1F6D2;</span>
      <span class="col-title ready">Ready for Collection</span>
      <span class="col-count ready" id="countReady">0</span>
    </div>
    <div class="col-cards" id="colReady"></div>
  </div>
</div>

<script type="module">
import { initializeApp }                                from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, query, where,
         onSnapshot, updateDoc, doc }                   from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:            "AIzaSyDrUKPNep2uxbZjYJ4i0vImdG7Xn_UuSXo",
  authDomain:        "rob-ph-demos.firebaseapp.com",
  projectId:         "rob-ph-demos",
  storageBucket:     "rob-ph-demos.firebasestorage.app",
  messagingSenderId: "199417645406",
  appId:             "1:199417645406:web:0e7a54d00083b41ea9e7cf"
};
const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);

const urlParams  = new URLSearchParams(window.location.search);
const STORE_CODE = (urlParams.get('store') || '').trim().toUpperCase();

// ── CLOCK ─────────────────────────────────────────────────────────────────
function updateClock() {
  document.getElementById('boardClock').textContent =
    new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
updateClock();
setInterval(updateClock, 1000);

// ── STORE LABEL ───────────────────────────────────────────────────────────
if (STORE_CODE) {
  document.getElementById('boardStore').textContent = 'Store: ' + STORE_CODE;
} else {
  document.body.innerHTML = `
    <div class="no-store">
      <h1>&#x1F4CB; Queue Board</h1>
      <p>Add <code>?store=YOUR_CODE</code> to the URL to get started</p>
    </div>`;
}

// ── DATA ──────────────────────────────────────────────────────────────────
let _orders = {};  // { [docId]: { orderNumber, customerName, queueStatus, queueEnteredAt, items } }

const TRANSITION_MS = {
  'waiting':     30 * 1000,   // → in-progress after 30 s
  'in-progress': 120 * 1000,  // → ready after 2 min (T+150 s total)
};
const CLEAR_AFTER_MS = 150 * 1000;  // remove from board 2.5 min after ready

// ── AUTO-ADVANCE TIMER ────────────────────────────────────────────────────
setInterval(() => {
  const now = Date.now();
  Object.entries(_orders).forEach(([id, order]) => {
    if (!order.queueEnteredAt) return;
    const entered = new Date(order.queueEnteredAt).getTime();
    const elapsed = now - entered;

    if (order.queueStatus === 'waiting' && elapsed >= TRANSITION_MS['waiting']) {
      order.queueStatus = 'in-progress';
      updateDoc(doc(db, 'carts', id), { queueStatus: 'in-progress' })
        .catch(e => console.warn('[Queue] transition failed:', e));
    } else if (order.queueStatus === 'in-progress' && elapsed >= TRANSITION_MS['waiting'] + TRANSITION_MS['in-progress']) {
      order.queueStatus = 'ready';
      updateDoc(doc(db, 'carts', id), { queueStatus: 'ready' })
        .catch(e => console.warn('[Queue] transition failed:', e));
    } else if (order.queueStatus === 'ready' && elapsed >= TRANSITION_MS['waiting'] + TRANSITION_MS['in-progress'] + CLEAR_AFTER_MS) {
      order.queueStatus = null;
      updateDoc(doc(db, 'carts', id), { queueStatus: null })
        .catch(e => console.warn('[Queue] clear failed:', e));
    }
  });
  renderBoard();
}, 2000);

// ── RENDER ────────────────────────────────────────────────────────────────
function renderBoard() {
  const cols = { waiting: [], 'in-progress': [], ready: [] };
  Object.values(_orders).forEach(o => {
    if (o.queueStatus && cols[o.queueStatus]) cols[o.queueStatus].push(o);
  });
  // Sort each column by entry time (oldest first)
  Object.values(cols).forEach(arr =>
    arr.sort((a, b) => (a.queueEnteredAt || '').localeCompare(b.queueEnteredAt || '')));

  renderCol('waiting',     cols['waiting'],     'colWaiting',  'countWaiting');
  renderCol('in-progress', cols['in-progress'], 'colProgress', 'countProgress');
  renderCol('ready',       cols['ready'],        'colReady',    'countReady');
}

function renderCol(status, orders, colId, countId) {
  document.getElementById(countId).textContent = orders.length;
  const el = document.getElementById(colId);
  el.innerHTML = orders.map(o => {
    const cls = status === 'in-progress' ? 'progress' : status;
    const name = o.customerName ? escHtml(o.customerName) : '';
    const num  = o.orderNumber  ? `#${escHtml(o.orderNumber)}` : '—';
    const itemCount = (o.items || []).reduce((s, i) => s + (i.qty || 1), 0);
    return `
      <div class="order-card ${cls}">
        <div class="card-number ${cls}">${num}</div>
        <div class="card-info">
          ${name ? `<div class="card-name">${name}</div>` : ''}
          <div class="card-items">${itemCount} item${itemCount !== 1 ? 's' : ''}</div>
        </div>
      </div>`;
  }).join('');
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ── FIRESTORE LISTENER ────────────────────────────────────────────────────
if (STORE_CODE) {
  const q = query(
    collection(db, 'carts'),
    where('storeCode', '==', STORE_CODE)
  );
  onSnapshot(q, snap => {
    snap.docs.forEach(d => {
      const data = d.data();
      if (data.queueStatus) {
        _orders[d.id] = {
          orderNumber:    data.orderNumber || null,
          customerName:   data.customerName || '',
          queueStatus:    data.queueStatus,
          queueEnteredAt: data.queueEnteredAt || null,
          items:          data.items || []
        };
      } else {
        delete _orders[d.id];
      }
    });
    renderBoard();
  });
}
</script>
</body>
</html>
